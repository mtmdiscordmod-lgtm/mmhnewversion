<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Consolas&family=Press+Start+2P&family=Verdana:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-deep: #020617;
        --primary: #22d3ee;       /* Cyan */
        --secondary: #fbbf24;     /* Amber */
        --muted: #94a3b8;         /* Slate */
        --border: #334155;        /* Slate 700 */
        --success: #34d399;       /* Emerald */
        --danger: #f87171;        /* Red */
      }

      body {
        background-color: var(--bg-deep);
        color: white;
        font-family: 'Verdana', sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden;
      }

      /* Animated Grid Background (Matches Index.html) */
      .grid-bg-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      }
      .grid-gradient {
        position: absolute; inset: 0;
        background: linear-gradient(135deg, #020617 0%, #083344 100%);
      }
      .grid-lines {
        position: absolute; inset: 0;
        background-size: 60px 60px;
        background-image: linear-gradient(to right, rgba(34, 211, 238, 0.05) 1px, transparent 1px),
                          linear-gradient(to bottom, rgba(34, 211, 238, 0.05) 1px, transparent 1px);
      }

      /* Card */
      .card {
        background: rgba(15, 23, 42, 0.9);
        border: 2px solid var(--primary);
        border-radius: 8px;
        padding: 40px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 0 50px rgba(34, 211, 238, 0.2);
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .logo { max-width: 150px; margin-bottom: 20px; }
      .title { font-family: 'Press Start 2P', cursive; color: var(--primary); font-size: 16px; margin-bottom: 10px; line-height: 1.5; }
      .subtitle { font-family: 'Consolas', monospace; color: var(--muted); font-size: 12px; margin-bottom: 30px; }

      /* Inventory Badge */
      .inv-badge {
        background: rgba(251, 191, 36, 0.1);
        border: 1px solid var(--secondary);
        color: var(--secondary);
        padding: 10px;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
        margin-bottom: 20px;
        display: inline-block;
      }
      .inv-count { font-weight: bold; font-size: 18px; }

      /* Form */
      .form-group { margin-bottom: 15px; text-align: left; }
      label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 5px; font-family: 'Consolas', monospace; }
      input {
        width: 100%; padding: 12px;
        background: #0f172a; border: 1px solid var(--border);
        color: white; font-family: 'Verdana'; font-size: 14px;
        border-radius: 4px; box-sizing: border-box;
      }
      input:focus { border-color: var(--primary); outline: none; }

      button {
        background: var(--primary); color: #020617;
        border: none; padding: 15px; width: 100%;
        font-weight: bold; font-family: 'Consolas', monospace;
        font-size: 16px; cursor: pointer; border-radius: 4px;
        transition: 0.2s; margin-top: 10px;
      }
      button:hover { background: #67e8f9; transform: translateY(-2px); box-shadow: 0 0 20px rgba(34, 211, 238, 0.4); }
      button:disabled { background: var(--muted); cursor: not-allowed; transform: none; box-shadow: none; }

      .error-msg { color: var(--danger); font-size: 12px; margin-top: 15px; display: none; }

      #success-view { display: none; }
      .success-icon { font-size: 50px; margin-bottom: 20px; display: block; }
    </style>
  </head>
  <body>
    <div class="grid-bg-container">
      <div class="grid-gradient"></div>
      <div class="grid-lines"></div>
    </div>

    <!-- LOADING -->
    <div id="loading" style="font-family: 'Consolas'; color: var(--primary);">Authenticating...</div>

    <!-- MAIN FORM -->
    <div class="card" id="main-card" style="display:none;">
      <img src="https://multimediaheroes.com/multimediaheroesassets/mmhlogo.png" class="logo">
      <div class="title">SONG REQUEST TERMINAL</div>
      <div class="subtitle">Exchange 1 Item for 1 Request</div>

      <div class="inv-badge">
        YOUR INVENTORY<br>
        <span class="inv-count" id="inv-count">...</span> Requests
      </div>

      <div id="form-content">
        <div class="form-group">
          <label>ARTIST</label>
          <input type="text" id="artist" placeholder="e.g. Rick Astley">
        </div>
        <div class="form-group">
          <label>SONG TITLE</label>
          <input type="text" id="song" placeholder="e.g. Never Gonna Give You Up">
        </div>
        <div class="form-group">
          <label>YOUTUBE LINK (OPTIONAL)</label>
          <input type="text" id="link" placeholder="https://youtube.com/...">
        </div>

        <button onclick="submitRequest()" id="btn-submit">SUBMIT REQUEST (-1 ITEM)</button>
        <div class="error-msg" id="error-msg"></div>
      </div>

      <div id="empty-state" style="display:none; color:var(--danger); padding:20px;">
        ‚ö†Ô∏è ACCESS DENIED<br><br>
        You do not have any Song Request items.<br>
        Win them in the Auction House!
      </div>
    </div>

    <!-- SUCCESS -->
    <div class="card" id="success-view">
      <span class="success-icon">üéâ</span>
      <div class="title">REQUEST CONFIRMED</div>
      <div style="color:var(--muted); margin-bottom:20px;">
        Your song has been added to the queue.<br>
        Inventory deducted.
      </div>
      <button onclick="location.reload()">MAKE ANOTHER REQUEST</button>
    </div>

    <script>
      window.onload = function() {
        google.script.run
          .withSuccessHandler(initProfile)
          .withFailureHandler(showError)
          .getStudentProfile();
      };

      function initProfile(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-card').style.display = 'block';

        const count = data.inventory;
        document.getElementById('inv-count').textContent = count;

        if (count > 0) {
          document.getElementById('form-content').style.display = 'block';
          document.getElementById('empty-state').style.display = 'none';
        } else {
          document.getElementById('form-content').style.display = 'none';
          document.getElementById('empty-state').style.display = 'block';
        }
      }

      function submitRequest() {
        const artist = document.getElementById('artist').value;
        const song = document.getElementById('song').value;
        const link = document.getElementById('link').value;

        if (!artist || !song) {
          showError("Please fill in Artist and Song.");
          return;
        }

        const btn = document.getElementById('btn-submit');
        btn.textContent = "PROCESSING...";
        btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
          if (res.success) {
            document.getElementById('main-card').style.display = 'none';
            document.getElementById('success-view').style.display = 'block';
          } else {
            showError(res.message);
            btn.textContent = "SUBMIT REQUEST (-1 ITEM)";
            btn.disabled = false;
          }
        }).submitSongRequest({
          artist: artist,
          song: song,
          link: link
        });
      }

      function showError(msg) {
        const el = document.getElementById('error-msg');
        el.textContent = msg; // Simple string, safe
        el.style.display = 'block';
      }
    </script>
  </body>
</html>
