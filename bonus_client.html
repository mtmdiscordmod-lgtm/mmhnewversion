<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --neon-blue: #00f3ff;
      --neon-pink: #ff00ff;
      --neon-green: #00ff9d;
      --neon-red: #ff0055;
      --bg-dark: #050510;
      --panel-bg: rgba(20, 20, 40, 0.9);
    }

    body {
      background-color: var(--bg-dark);
      color: white;
      font-family: 'Rajdhani', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* BACKGROUND GRID */
    .grid-bg {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background:
        linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
      background-size: 40px 40px;
      perspective: 500px;
      transform-style: preserve-3d;
      z-index: -1;
      opacity: 0.3;
    }

    /* HEADER */
    .header {
      padding: 15px;
      background: linear-gradient(90deg, #000, #1a1a3a);
      border-bottom: 2px solid var(--neon-blue);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    }
    .title {
      font-family: 'Press Start 2P', cursive;
      font-size: 14px;
      color: var(--neon-blue);
      text-shadow: 0 0 5px var(--neon-blue);
    }
    .round-badge {
      background: var(--neon-pink);
      color: #000;
      padding: 5px 10px;
      font-weight: bold;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 0 10px var(--neon-pink);
    }

    /* MAIN CONTAINER */
    .container {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    /* STATUS PANEL */
    .status-panel {
      background: var(--panel-bg);
      border: 1px solid var(--neon-blue);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .status-text {
      font-size: 18px;
      font-weight: bold;
      color: var(--neon-green);
      margin-bottom: 10px;
    }

    /* ENERGY BAR */
    .energy-container {
      width: 100%;
      height: 20px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #555;
      position: relative;
    }
    .energy-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
      width: 100%;
      transition: width 0.5s ease;
    }
    .energy-text {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px black;
    }

    /* QUESTION CARD */
    .question-card {
      background: rgba(0,0,0,0.8);
      border: 2px solid var(--neon-pink);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.2);
      animation: glowPulse 4s infinite alternate;
    }
    @keyframes glowPulse {
      0% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.2); }
      100% { box-shadow: 0 0 40px rgba(255, 0, 255, 0.5); }
    }

    .q-text {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .media-container {
      width: 100%;
      margin-bottom: 15px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #333;
      display: none; /* Hidden by default */
    }
    .media-container img, .media-container iframe {
      width: 100%;
      height: auto;
      display: block;
    }
    .media-container iframe {
      aspect-ratio: 16 / 9;
    }

    /* ANSWER GRID */
    .answer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .btn-answer {
      background: rgba(0, 243, 255, 0.1);
      border: 2px solid var(--neon-blue);
      color: var(--neon-blue);
      padding: 20px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 8px;
      text-transform: uppercase;
    }
    .btn-answer:active {
      transform: scale(0.95);
    }
    .btn-answer.selected {
      background: var(--neon-blue);
      color: #000;
      box-shadow: 0 0 20px var(--neon-blue);
    }
    .btn-answer:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    /* SHAKE EFFECT */
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-2px, 0, 0); }
      20%, 80% { transform: translate3d(4px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
      40%, 60% { transform: translate3d(8px, 0, 0); }
    }

    /* DAMAGE OVERLAY */
    .damage-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle, transparent 50%, rgba(255,0,0,0.5) 100%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 100;
    }
    .damage-active { opacity: 1; }

    /* LOADING SPINNER */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      width: 40px; height: 40px;
      border-radius: 50%;
      border-left-color: var(--neon-blue);
      animation: spin 1s linear infinite;
      margin: 50px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div class="grid-bg"></div>
  <div class="damage-overlay" id="damage-fx"></div>

  <div class="header">
    <div class="title">MMH BONUS</div>
    <div class="round-badge" id="round-display">WAITING</div>
  </div>

  <div class="container" id="main-container">

    <!-- ENERGY BAR -->
    <div class="energy-container">
      <div class="energy-fill" id="hp-bar" style="width: 100%;"></div>
      <div class="energy-text" id="hp-text">100% ENERGY</div>
    </div>

    <!-- CONTENT AREA -->
    <div id="content-area">
      <div class="spinner"></div>
      <div style="text-align: center; color: #888;">Connecting to Neural Net...</div>
    </div>

  </div>

  <script>
    // --- STATE ---
    let gameId = '';
    let lastRound = -1;
    let hasAnswered = false;
    let lastDamage = 0;
    let pollInterval = null;

    // --- INIT ---
    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      gameId = urlParams.get('gameId');

      if (!gameId) {
        showError("Missing Game ID. Check your link.");
        return;
      }

      console.log("Client Initialized. Game ID: " + gameId);
      pollState(); // First fetch immediately
    };

    // --- NETWORKING ---
    function pollState() {
      google.script.run
        .withSuccessHandler(handleState)
        .withFailureHandler(err => console.error("Poll error", err))
        .fetchGameState(gameId);

      // Jittered Polling (2000ms - 4000ms)
      const jitter = 2000 + Math.random() * 2000;
      setTimeout(pollState, jitter);
    }

    function handleState(state) {
      if (state.error) {
        showError(state.error);
        return;
      }

      updateHUD(state);

      if (state.status === 'WAITING') {
        renderWaiting("Waiting for Teacher to Start...");
      } else if (state.status === 'GAME_OVER') {
        renderMessage("GAME OVER", "Mission Failed. The class ran out of energy.", "red");
      } else if (state.status === 'VICTORY') {
        renderMessage("VICTORY!", "Mission Accomplished! Rewards Unlocked.", "gold");
      } else if (state.status === 'PLAYING') {
        // Check if round changed
        if (state.currentRound !== lastRound) {
          lastRound = state.currentRound;
          hasAnswered = false; // Reset answer lock
          renderQuestion(state.question);
        }
      }

      // FX Check
      if (state.lastDamage > 0 && state.lastDamage !== lastDamage) {
        triggerDamageFX();
        lastDamage = state.lastDamage;
      }
    }

    function submitAnswer(idx, btn) {
      if (hasAnswered) return;

      hasAnswered = true;

      // UI Feedback
      const buttons = document.querySelectorAll('.btn-answer');
      buttons.forEach(b => b.disabled = true);
      btn.classList.add('selected');
      btn.disabled = false; // Keep selected one "active" looking

      google.script.run
        .withSuccessHandler(() => console.log("Answer submitted"))
        .withFailureHandler(err => console.error("Submit error", err))
        .submitGameAnswer(gameId, idx);
    }

    // --- RENDERING ---

    function updateHUD(state) {
      // Round
      document.getElementById('round-display').textContent =
        state.status === 'PLAYING' ? `ROUND ${state.currentRound + 1}/${state.totalRounds}` : state.status;

      // HP
      const hpPercent = Math.max(0, Math.min(100, (state.currentEnergy / state.maxEnergy) * 100));
      const hpBar = document.getElementById('hp-bar');
      hpBar.style.width = hpPercent + "%";
      document.getElementById('hp-text').textContent = state.currentEnergy + " ENERGY";

      // Color logic
      if (hpPercent > 60) hpBar.style.background = "linear-gradient(90deg, #00ff9d, #00f3ff)"; // Green/Blue
      else if (hpPercent > 30) hpBar.style.background = "linear-gradient(90deg, #ffd700, #ff8c00)"; // Yellow/Orange
      else hpBar.style.background = "linear-gradient(90deg, #ff0055, #ff0000)"; // Red
    }

    function renderQuestion(q) {
      if (!q) return;

      const container = document.getElementById('content-area');
      container.innerHTML = '';

      // 1. Question Card
      const card = document.createElement('div');
      card.className = 'question-card';

      // Media
      if (q.media) {
        let mediaHtml = '';
        if (q.media.includes('youtube') || q.media.includes('youtu.be')) {
          // Extract ID
          const match = q.media.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
          if (match) {
            mediaHtml = `<div class="media-container" style="display:block;">
              <iframe src="https://www.youtube.com/embed/${match[1]}?autoplay=1&mute=0&controls=0" frameborder="0" allow="autoplay; encrypted-media"></iframe>
            </div>`;
          }
        } else {
          // Image
          mediaHtml = `<div class="media-container" style="display:block;">
            <img src="${q.media}">
          </div>`;
        }
        card.innerHTML += mediaHtml;
      }

      // Text
      card.innerHTML += `<div class="q-text">${q.text}</div>`;

      // 2. Answer Grid
      const grid = document.createElement('div');
      grid.className = 'answer-grid';

      // Parse JSON
      let answerData = { options: [] };
      try {
        answerData = JSON.parse(q.answerJson);
      } catch(e) { console.error("JSON parse error", e); }

      if (q.type === 'DECISION') {
        // Yes/No Style
        const yBtn = createButton('YES', 0);
        const nBtn = createButton('NO', 1);
        yBtn.style.borderColor = 'var(--neon-green)'; yBtn.style.color = 'var(--neon-green)';
        nBtn.style.borderColor = 'var(--neon-red)'; nBtn.style.color = 'var(--neon-red)';
        grid.appendChild(yBtn);
        grid.appendChild(nBtn);
      } else {
        // Trivia
        answerData.options.forEach((opt, i) => {
          grid.appendChild(createButton(opt, i));
        });
      }

      container.appendChild(card);
      container.appendChild(grid);
    }

    function createButton(text, index) {
      const btn = document.createElement('button');
      btn.className = 'btn-answer';
      btn.textContent = text;
      btn.onclick = () => submitAnswer(index, btn);
      return btn;
    }

    function renderWaiting(msg) {
      const container = document.getElementById('content-area');
      // Only update if not already showing waiting to prevent flicker
      if (!container.innerHTML.includes('status-panel')) {
        container.innerHTML = `
          <div class="status-panel">
            <div class="status-text">‚è≥ STANDBY</div>
            <div>${msg}</div>
            <div class="spinner" style="margin-top:20px; width:30px; height:30px;"></div>
          </div>
        `;
      }
    }

    function renderMessage(title, desc, color) {
      const container = document.getElementById('content-area');
      const colorCode = color === 'red' ? 'var(--neon-red)' : 'var(--neon-green)';
      container.innerHTML = `
        <div class="status-panel" style="border-color:${colorCode};">
          <div class="status-text" style="color:${colorCode}; font-size:24px;">${title}</div>
          <div style="font-size:16px;">${desc}</div>
        </div>
      `;
    }

    function showError(msg) {
      const container = document.getElementById('content-area');
      container.innerHTML = `<div style="color:var(--neon-red); text-align:center; font-weight:bold;">ERROR: ${msg}</div>`;
    }

    // --- FX ---
    function triggerDamageFX() {
      const body = document.body;
      const overlay = document.getElementById('damage-fx');

      body.classList.add('shake');
      overlay.classList.add('damage-active');

      setTimeout(() => {
        body.classList.remove('shake');
        overlay.classList.remove('damage-active');
      }, 500);
    }

  </script>
</body>
</html>
