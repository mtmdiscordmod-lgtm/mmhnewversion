<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Consolas&family=Press+Start+2P&family=Verdana:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-deep: #020617;
        --bg-header: #0f172a;
        --primary: #22d3ee;       /* Cyan 400 */
        --secondary: #fbbf24;     /* Amber 400 */
        --muted: #94a3b8;         /* Slate 400 */
        --border: #334155;        /* Slate 700 */
        --success: #34d399;       /* Emerald */
        --danger: #f87171;        /* Red */
        --warning: #f97316;       /* Orange */

        /* JRPG Theme */
        --rpg-gold: #fbbf24;
        --rpg-bg: #1e1b4b;
        --rpg-dark: #0f172a;
        --rpg-panel: rgba(15, 23, 42, 0.95);
      }

      /* ==================== GLOBAL ANIMATED GRID ==================== */
      /* Base Container */
      .grid-bg-container {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -50;
        overflow: hidden;
        background: var(--bg-deep);
        transition: opacity 0.5s ease;
      }

      /* Keyframes */
      @keyframes bgScroll {
          0% { background-position: 0% 0%; }
          100% { background-position: 100% 100%; }
      }
      @keyframes gridPulse {
          0%, 100% { opacity: 0.2; }
          50% { opacity: 0.6; }
      }

      /* Moving Gradient Layer */
      .grid-gradient {
        position: absolute;
        inset: 0;
        background-size: 400% 400%;
        animation: bgScroll 20s ease-in-out infinite alternate;
      }

      /* Pulsing Grid Layer */
      .grid-lines {
        position: absolute;
        inset: 0;
        background-size: 60px 60px;
        animation: gridPulse 4s ease-in-out infinite;
      }

      /* Vignette Overlay */
      .grid-vignette {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle, transparent 40%, rgba(2, 6, 23, 0.8) 100%);
        pointer-events: none;
      }

      /* --- THEMES --- */

      /* Theme: Cyan (Default/Console) */
      .theme-cyan .grid-gradient {
        background-image: linear-gradient(135deg, #020617 0%, #083344 50%, #020617 100%); /* Slate-950 via Cyan-950 */
      }
      .theme-cyan .grid-lines {
        background-image:
          linear-gradient(to right, rgba(34, 211, 238, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(34, 211, 238, 0.1) 1px, transparent 1px);
      }

      /* Theme: Gold (Leaderboard) */
      .theme-gold .grid-gradient {
        background-image: linear-gradient(135deg, #1e1b4b 0%, #451a03 50%, #1e1b4b 100%); /* Indigo to Amber-dark */
      }
      .theme-gold .grid-lines {
        background-image:
          linear-gradient(to right, rgba(251, 191, 36, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(251, 191, 36, 0.1) 1px, transparent 1px);
      }

      /* Theme: Purple (Auction) */
      .theme-purple .grid-gradient {
        background-image: linear-gradient(135deg, #2e1065 0%, #4c1d95 50%, #2e1065 100%); /* Violet-950 */
      }
      .theme-purple .grid-lines {
        background-image:
          linear-gradient(to right, rgba(192, 132, 252, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(192, 132, 252, 0.1) 1px, transparent 1px);
      }

      /* Theme: Pink (Song Manager) */
      .theme-pink .grid-gradient {
        background-image: linear-gradient(135deg, #500724 0%, #831843 50%, #500724 100%); /* Pink-950 */
      }
      .theme-pink .grid-lines {
        background-image:
          linear-gradient(to right, rgba(244, 114, 182, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(244, 114, 182, 0.1) 1px, transparent 1px);
      }

      /* Theme: Green (Bonus Round) */
      .theme-green .grid-gradient {
        background-image: linear-gradient(135deg, #022c22 0%, #064e3b 50%, #022c22 100%); /* Green-950 */
      }
      .theme-green .grid-lines {
        background-image:
          linear-gradient(to right, rgba(52, 211, 153, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(52, 211, 153, 0.1) 1px, transparent 1px);
      }

      body {
        background-color: transparent; /* Changed to show grid */
        color: var(--muted);
        font-family: 'Verdana', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* ==================== NAV ==================== */
      .main-nav {
        width: 100%;
        background: rgba(15, 23, 42, 0.9); /* Slight transparency */
        backdrop-filter: blur(5px);
        border-bottom: 2px solid var(--primary);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        padding: 10px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        box-sizing: border-box;
      }
      .nav-btn {
        background: transparent;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 8px 20px;
        font-family: 'Consolas', monospace;
        cursor: pointer;
        transition: 0.2s;
        border-radius: 4px;
      }
      .nav-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
      }
      .nav-btn.active {
        background: var(--primary);
        color: var(--bg-deep);
        border-color: var(--primary);
        font-weight: bold;
        box-shadow: 0 0 15px var(--primary);
      }

      /* GLOBAL CLASS SELECTOR (Moved to Nav) */
      #class-select {
        background: #0f172a;
        color: #fbbf24;
        border: 1px solid #334155;
        padding: 8px;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
        min-width: 200px;
      }

      /* ==================== LOADING ==================== */
      #loading-screen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-deep);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        width: 50px; height: 50px;
        border: 5px solid var(--border);
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* ==================== SHREK GATE ==================== */
      #shrek-gate {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100%;
        text-align: center;
      }
      .shrek-container {
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .shrek-container:hover { transform: scale(1.05); }
      .shrek-img {
        max-width: 400px;
        border: 5px solid var(--danger);
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(248, 113, 113, 0.5);
      }
      .meme-text {
        font-family: 'Comic Sans MS', 'Verdana';
        font-size: 80px;
        color: var(--secondary);
        font-weight: bold;
        text-shadow: 3px 3px 0 #000;
        margin-top: 20px;
        animation: memeMove 2s infinite ease-in-out;
      }
      @keyframes memeMove {
        0% { transform: scale(1) rotate(0deg); }
        25% { transform: scale(1.1) rotate(5deg); }
        50% { transform: scale(1) rotate(0deg); }
        75% { transform: scale(1.1) rotate(-5deg); }
        100% { transform: scale(1) rotate(0deg); }
      }
      .gate-info {
        margin-top: 20px;
        color: var(--muted);
        font-size: 16px;
        background: rgba(0,0,0,0.5);
        padding: 15px;
        border-radius: 5px;
        border: 1px solid var(--border);
      }
      #detected-email {
        font-family: 'Consolas', monospace;
        color: var(--secondary);
        font-weight: bold;
        font-size: 18px;
        margin-top: 5px;
        background: #451a03;
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
      }
      .gate-hint {
        color: var(--primary);
        font-weight: bold;
        margin-top: 10px;
        font-size: 14px;
        text-transform: uppercase;
        animation: pulse 2s infinite;
      }

      /* ==================== DASHBOARD (CONSOLE) ==================== */
      #dashboard {
        display: none;
        width: 100%;
        max-width: 1000px;
        padding: 20px;
      }
      .header {
        border-bottom: 2px solid var(--primary);
        padding-bottom: 10px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(15, 23, 42, 0.8);
        padding: 20px;
        border-radius: 8px;
      }
      .title {
        font-family: 'Consolas', monospace;
        color: var(--primary);
        font-size: 24px;
        font-weight: bold;
      }
      .subtitle { color: var(--secondary); font-size: 14px; }

      .control-panel {
        background: rgba(15, 23, 42, 0.9);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 20px;
        backdrop-filter: blur(5px);
      }
      .row { display: flex; gap: 20px; margin-bottom: 15px; }
      .col { flex: 1; display: flex; flex-direction: column; }
      label { font-family: 'Consolas', monospace; color: var(--primary); margin-bottom: 5px; font-size: 12px; }
      select, button, input {
        background: var(--bg-deep); color: white; border: 1px solid var(--border);
        padding: 10px; border-radius: 4px; font-family: 'Verdana'; font-size: 14px;
      }
      select:focus, button:hover, input:focus { border-color: var(--primary); outline: none; }
      button { cursor: pointer; font-weight: bold; transition: 0.2s; }
      .btn-primary { background: var(--primary); color: var(--bg-deep); border: none; }
      .btn-primary:hover { background: #67e8f9; box-shadow: 0 0 10px var(--primary); }
      .btn-secondary { background: var(--bg-header); color: var(--secondary); border: 1px solid var(--secondary); }
      .btn-secondary:hover { background: rgba(251, 191, 36, 0.1); }
      #action-area { display: flex; gap: 20px; margin-top: 20px; }
      #org-result { margin-top: 10px; font-family: 'Consolas', monospace; }

      /* ==================== SONG MANAGER VIEW ==================== */
      #song-manager-view {
        display: none;
        width: 100%;
        max-width: 1200px;
        padding: 20px;
        height: 85vh;
        gap: 20px;
      }
      .song-flex {
        display: flex;
        width: 100%;
        height: 100%;
        gap: 20px;
      }
      .song-col {
        flex: 1;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid var(--border);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(5px);
        overflow: hidden;
      }
      .song-header {
        background: rgba(0,0,0,0.3);
        padding: 15px;
        border-bottom: 1px solid var(--border);
        font-family: 'Consolas', monospace;
        font-weight: bold;
        color: #db2777; /* Pink-600 */
        display: flex; justify-content: space-between; align-items: center;
      }
      .song-list {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .song-card {
        background: rgba(255,255,255,0.03);
        padding: 10px;
        border-radius: 4px;
        border-left: 3px solid #db2777;
        display: flex; justify-content: space-between; align-items: center;
      }
      .song-card.staged { border-left-color: #34d399; background: rgba(52, 211, 153, 0.1); }

      .song-info { font-size: 14px; }
      .song-meta { font-size: 11px; color: var(--muted); }

      .btn-stage { background: transparent; border: 1px solid #db2777; color: #db2777; padding: 5px 10px; font-size: 11px; }
      .btn-stage:hover { background: #db2777; color: white; }

      .btn-remove { background: transparent; border: 1px solid var(--muted); color: var(--muted); padding: 5px 10px; font-size: 11px; }
      .btn-remove:hover { border-color: var(--danger); color: var(--danger); }

      .playlist-actions {
        padding: 20px;
        border-top: 1px solid var(--border);
        text-align: center;
      }
      .btn-finalize {
        background: #db2777; color: white; width: 100%; padding: 15px; font-size: 16px;
      }
      .btn-finalize:hover { background: #be185d; box-shadow: 0 0 15px #db2777; }
      .btn-finalize:disabled { background: var(--muted); cursor: not-allowed; box-shadow: none; }
      a { color: var(--success); text-decoration: none; border-bottom: 1px dashed var(--success); }

      /* ==================== LEADERBOARD (JRPG) ==================== */
      #leaderboard-view {
        display: none;
        width: 100%;
        max-width: 1200px;
        padding: 20px;
        /* background removed, handled by grid */
      }
      .rpg-header {
        text-align: center;
        margin-bottom: 20px;
      }
      .rpg-logo {
        max-width: 400px;
        filter: drop-shadow(0 0 10px var(--primary));
      }

      /* Filters */
      .rpg-filters {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
      }
      .rpg-select {
        background: rgba(0,0,0,0.5);
        color: var(--rpg-gold);
        border: 2px solid var(--rpg-gold);
        padding: 5px 15px;
        font-family: 'Consolas', monospace;
      }
      .studio-tabs {
        display: flex;
        gap: 5px;
      }
      .studio-tab {
        background: transparent;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 5px 15px;
        cursor: pointer;
        font-size: 12px;
      }
      .studio-tab.active {
        background: var(--rpg-gold);
        color: #000;
        border-color: var(--rpg-gold);
        font-weight: bold;
        box-shadow: 0 0 10px var(--rpg-gold);
      }

      /* ==================== OVERLORD TABS ==================== */
      .overlord-tab {
        background: transparent;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 10px 20px;
        cursor: pointer;
        font-size: 13px;
        font-family: 'Consolas', monospace;
        transition: 0.2s;
      }
      .overlord-tab:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .overlord-tab.active {
        background: var(--primary);
        color: #000;
        border-color: var(--primary);
        font-weight: bold;
        box-shadow: 0 0 10px var(--primary);
      }

      /* Test Student Card */
      .test-student-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        border-left: 3px solid var(--warning);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .test-student-card:hover {
        background: rgba(255,255,255,0.05);
      }
      .test-student-info { flex: 1; }
      .test-student-name { font-weight: bold; color: white; }
      .test-student-meta { font-size: 12px; color: var(--muted); }
      .test-student-actions { display: flex; gap: 10px; }

      /* Search result item */
      .manage-search-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: 0.2s;
      }
      .manage-search-item:hover {
        background: var(--primary);
        color: #000;
      }
      .manage-search-item strong { display: block; }
      .manage-search-item span { font-size: 11px; opacity: 0.8; }

      /* Inventory tag */
      .inv-tag {
        display: inline-block;
        background: rgba(251, 191, 36, 0.2);
        border: 1px solid var(--secondary);
        color: var(--secondary);
        padding: 4px 10px;
        margin: 3px;
        border-radius: 4px;
        font-size: 12px;
      }

      /* ==================== CURRICULUM BUILDER ==================== */
      .curriculum-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .curriculum-header h2 {
        color: var(--primary);
        font-family: 'Consolas', monospace;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .curriculum-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .curriculum-tab {
        background: transparent;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 10px 20px;
        cursor: pointer;
        font-size: 13px;
        font-family: 'Consolas', monospace;
        transition: 0.2s;
      }
      .curriculum-tab:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .curriculum-tab.active {
        background: var(--primary);
        color: #000;
        border-color: var(--primary);
        font-weight: bold;
        box-shadow: 0 0 10px var(--primary);
      }

      /* Studio Cards */
      .studio-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .studio-card {
        background: rgba(15, 23, 42, 0.8);
        border: 2px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s;
      }
      .studio-card:hover {
        transform: translateY(-4px);
        border-color: var(--primary);
        box-shadow: 0 8px 30px rgba(34, 211, 238, 0.2);
      }
      .studio-card.expanded {
        grid-column: 1 / -1;
        cursor: default;
      }
      .studio-card-header {
        padding: 20px;
        background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), transparent);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .studio-card.sound .studio-card-header { background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), transparent); }
      .studio-card.visual .studio-card-header { background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), transparent); }
      .studio-card.interactive .studio-card-header { background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), transparent); }
      .studio-card-title {
        font-size: 18px;
        font-weight: bold;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .studio-card.sound .studio-card-title { color: #a855f7; }
      .studio-card.visual .studio-card-title { color: #ec4899; }
      .studio-card.interactive .studio-card-title { color: #22d3ee; }
      .studio-stats {
        display: flex;
        gap: 15px;
        font-size: 12px;
        color: var(--muted);
      }
      .studio-stats span { display: flex; align-items: center; gap: 5px; }
      .studio-card-body {
        padding: 15px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease;
      }
      .studio-card.expanded .studio-card-body {
        max-height: 2000px;
      }

      /* Track Accordion */
      .track-list { display: flex; flex-direction: column; gap: 10px; }
      .track-item {
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }
      .track-header {
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .track-header:hover { background: rgba(255,255,255,0.03); }
      .track-header.expanded { background: rgba(34, 211, 238, 0.1); border-bottom: 1px solid var(--border); }
      .track-info { display: flex; align-items: center; gap: 15px; }
      .track-code {
        background: var(--primary);
        color: #000;
        padding: 4px 10px;
        border-radius: 4px;
        font-family: monospace;
        font-weight: bold;
        font-size: 12px;
      }
      .track-name { color: white; font-weight: 600; }
      .track-meta {
        display: flex;
        gap: 10px;
        font-size: 12px;
        color: var(--muted);
      }
      .track-levels-count {
        background: rgba(251, 191, 36, 0.2);
        color: var(--secondary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
      }
      .track-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
      }
      .track-item.expanded .track-body { max-height: 3000px; }

      /* Level Cards */
      .levels-container { padding: 15px; background: rgba(0,0,0,0.2); }
      .level-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        border-left: 4px solid var(--secondary);
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .level-header {
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .level-header:hover { background: rgba(255,255,255,0.02); }
      .level-badge {
        background: var(--secondary);
        color: #000;
        padding: 3px 10px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 12px;
      }
      .level-title { color: white; margin-left: 10px; }
      .level-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        border-top: 1px solid transparent;
      }
      .level-card.expanded .level-body {
        max-height: 2000px;
        border-top-color: var(--border);
      }

      /* Assignment Cards */
      .assignments-container { padding: 15px; }
      .assignment-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 12px;
        overflow: hidden;
      }
      .assignment-header {
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: 0.2s;
      }
      .assignment-header:hover { background: rgba(255,255,255,0.03); }
      .assignment-header.expanded { background: rgba(52, 211, 153, 0.1); }
      .assignment-num {
        background: var(--success);
        color: #000;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }
      .assignment-title {
        color: white;
        flex: 1;
        margin-left: 10px;
        cursor: text;
      }
      .assignment-mp {
        color: var(--success);
        font-weight: bold;
        font-size: 14px;
      }
      .assignment-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .assignment-card.expanded .assignment-body { max-height: 1500px; }

      /* Achievement List */
      .achievements-container { padding: 15px; background: rgba(0,0,0,0.15); }
      .achievement-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: grab;
        transition: all 0.2s;
      }
      .achievement-item:hover {
        background: rgba(255,255,255,0.05);
        border-color: var(--primary);
      }
      .achievement-item.dragging {
        opacity: 0.5;
        transform: scale(1.02);
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      }
      .achievement-drag-handle {
        color: var(--muted);
        cursor: grab;
        padding: 5px;
      }
      .achievement-drag-handle:active { cursor: grabbing; }
      .achievement-num {
        background: rgba(34, 211, 238, 0.2);
        color: var(--primary);
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        min-width: 25px;
        text-align: center;
      }
      .achievement-name {
        flex: 1;
        color: white;
      }
      .achievement-mp-input {
        width: 60px;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--border);
        color: var(--success);
        padding: 5px 8px;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
      }
      .achievement-mp-input:focus {
        border-color: var(--primary);
        outline: none;
      }
      .achievement-resource {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .resource-indicator {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
      }
      .resource-indicator.youtube { background: rgba(255, 0, 0, 0.2); color: #ff0000; }
      .resource-indicator.link { background: rgba(34, 211, 238, 0.2); color: var(--primary); }
      .resource-indicator.file { background: rgba(251, 191, 36, 0.2); color: var(--secondary); }
      .resource-indicator.none { background: rgba(255,255,255,0.05); color: var(--muted); }
      .achievement-actions {
        display: flex;
        gap: 5px;
      }
      .ach-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 5px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: 0.2s;
      }
      .ach-btn:hover { border-color: var(--primary); color: var(--primary); }
      .ach-btn.delete:hover { border-color: var(--danger); color: var(--danger); }

      /* Add buttons */
      .add-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        background: rgba(34, 211, 238, 0.1);
        border: 2px dashed var(--primary);
        color: var(--primary);
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Consolas', monospace;
        font-size: 13px;
        transition: 0.2s;
        margin-top: 10px;
      }
      .add-btn:hover {
        background: rgba(34, 211, 238, 0.2);
        border-style: solid;
      }

      /* Progress bar for publishing */
      .publish-progress {
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        margin: 15px 0;
      }
      .publish-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--success));
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #000;
        font-size: 11px;
        font-weight: bold;
      }

      /* Curriculum modals */
      .curriculum-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .curriculum-modal-content {
        background: var(--bg-header);
        border: 2px solid var(--primary);
        border-radius: 8px;
        padding: 25px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .curriculum-modal h3 {
        color: var(--primary);
        margin-top: 0;
        margin-bottom: 20px;
        font-family: 'Consolas', monospace;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        color: var(--muted);
        margin-bottom: 5px;
        font-size: 12px;
        text-transform: uppercase;
      }
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--border);
        color: white;
        border-radius: 4px;
        font-size: 14px;
      }
      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        border-color: var(--primary);
        outline: none;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
      }

      /* Events section */
      .event-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
      }
      .event-card.active { border-color: var(--primary); }
      .event-card.upcoming { border-color: var(--secondary); }
      .event-card.past { opacity: 0.6; }
      .event-status {
        position: absolute;
        top: 0;
        right: 0;
        padding: 5px 15px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .event-status.active { background: var(--primary); color: #000; }
      .event-status.upcoming { background: var(--secondary); color: #000; }
      .event-status.past { background: var(--muted); color: #000; }
      .event-title { color: white; font-size: 18px; margin-bottom: 5px; }
      .event-dates { color: var(--muted); font-size: 12px; margin-bottom: 10px; }
      .event-tiers {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .event-tier {
        background: rgba(0,0,0,0.2);
        padding: 8px 15px;
        border-radius: 4px;
        text-align: center;
      }
      .event-tier-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
      .event-tier-mp { font-weight: bold; color: var(--secondary); }

      /* History panel */
      .history-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-bottom: 1px solid var(--border);
        font-size: 12px;
      }
      .history-item.undone { opacity: 0.5; text-decoration: line-through; }
      .history-action {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .history-action.create { background: rgba(52, 211, 153, 0.2); color: var(--success); }
      .history-action.update { background: rgba(34, 211, 238, 0.2); color: var(--primary); }
      .history-action.delete { background: rgba(248, 113, 113, 0.2); color: var(--danger); }
      .history-time { color: var(--muted); min-width: 140px; }
      .history-entity { flex: 1; color: white; }
      .history-undo {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 3px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
      }
      .history-undo:hover { border-color: var(--warning); color: var(--warning); }

      /* RPG Panels */
      .rpg-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }
      .rpg-panel {
        background: var(--rpg-panel);
        border: 2px solid var(--rpg-gold);
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        position: relative;
      }
      .rpg-panel::before {
        /* Corner Accent */
        content: ""; position: absolute; top: -4px; left: -4px;
        width: 10px; height: 10px; background: var(--rpg-gold);
        box-shadow: 2px 2px 0 #000;
      }
      .panel-title {
        color: var(--rpg-gold);
        font-family: 'Consolas', monospace; /* Use Consolas for clean look */
        font-size: 18px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 15px;
        border-bottom: 1px dashed var(--border);
        padding-bottom: 10px;
      }

      /* List Items */
      .rpg-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .rpg-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 5px;
        background: rgba(255,255,255,0.03);
        border-left: 3px solid transparent;
        animation: slideIn 0.5s ease-out forwards;
        opacity: 0;
      }
      @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

      .rpg-item:nth-child(1) { border-color: #ffd700; background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); }
      .rpg-item:nth-child(2) { border-color: #c0c0c0; }
      .rpg-item:nth-child(3) { border-color: #cd7f32; }

      .char-info { display: flex; flex-direction: column; }
      .char-name { font-weight: bold; color: #fff; font-size: 14px; }
      .char-meta { font-size: 10px; color: var(--muted); }
      .char-score {
        font-family: 'Consolas', monospace;
        color: var(--primary);
        font-size: 16px;
        font-weight: bold;
        text-shadow: 0 0 5px var(--primary);
      }

      /* ==================== AUCTION VIEW ==================== */
      #auction-view {
        display: none;
        width: 100%;
        max-width: 1200px;
        padding: 20px;
        height: 85vh;
        gap: 20px;
      }

      .auction-flex {
        display: flex;
        width: 100%;
        height: 100%;
        gap: 20px;
      }

      /* LEFT: Item Grid */
      .item-grid-container {
        flex: 2;
        background: rgba(15, 23, 42, 0.8);
        border: 2px solid var(--primary);
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        align-content: start;
        backdrop-filter: blur(5px);
      }

      .auction-card {
        background: rgba(0,0,0,0.5);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: 0.2s;
        position: relative;
      }
      .auction-card:hover { transform: translateY(-5px); border-color: var(--secondary); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
      .auction-card.selected { border: 3px solid var(--secondary); box-shadow: 0 0 20px var(--secondary); transform: scale(1.02); }

      .card-img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-bottom: 1px solid var(--border); }
      .card-body { padding: 10px; text-align: center; }
      .card-title { font-weight: bold; color: white; margin-bottom: 5px; font-size: 14px; }
      .card-price { color: var(--secondary); font-family: 'Consolas', monospace; font-size: 12px; }

      /* RIGHT: Desk */
      .auction-desk {
        flex: 1;
        background: rgba(15, 23, 42, 0.95);
        border: 2px solid var(--secondary);
        border-radius: 8px;
        padding: 25px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
        backdrop-filter: blur(10px);
      }

      .desk-header { text-align: center; border-bottom: 1px dashed var(--border); padding-bottom: 15px; }
      .desk-title { font-family: 'Press Start 2P', cursive; color: var(--secondary); font-size: 16px; margin-bottom: 5px; line-height: 1.5; }
      .desk-subtitle { color: var(--muted); font-size: 12px; }

      .desk-section { display: flex; flex-direction: column; gap: 5px; }
      .desk-label { font-family: 'Consolas', monospace; color: var(--primary); font-size: 12px; text-transform: uppercase; }

      .student-search-box { position: relative; }
      #student-search-input { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); color: white; font-size: 16px; box-sizing: border-box; }
      #search-results {
        position: absolute; top: 100%; left: 0; width: 100%;
        background: #1e293b; border: 1px solid var(--primary);
        max-height: 200px; overflow-y: auto; z-index: 50;
        display: none;
      }
      .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; transition: 0.2s; }
      .search-item:hover { background: var(--primary); color: #000; }
      .search-item strong { display: block; font-size: 14px; }
      .search-item span { font-size: 11px; opacity: 0.8; }

      .bid-area { display: flex; gap: 10px; align-items: flex-end; }
      #bid-input { font-family: 'Consolas', monospace; font-size: 24px; color: var(--secondary); text-align: center; width: 100px; }

      .feedback-box {
        margin-top: auto;
        padding: 15px;
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
        min-height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-weight: bold;
        font-size: 18px;
        font-family: 'Consolas', monospace;
        border: 1px solid var(--border);
        transition: 0.3s;
      }
      .feedback-success { background: rgba(52, 211, 153, 0.2); color: var(--success); border-color: var(--success); }
      .feedback-error { background: rgba(248, 113, 113, 0.2); color: var(--danger); border-color: var(--danger); }

      .action-btns { display: flex; gap: 10px; margin-top: 10px; }
      .btn-check { flex: 1; background: var(--warning); color: #431407; border: none; font-weight: bold; padding: 15px; font-size: 16px; }
      .btn-sold { flex: 1; background: var(--success); color: #064e3b; border: none; font-weight: bold; padding: 15px; font-size: 16px; }
      .btn-check:hover, .btn-sold:hover { filter: brightness(1.2); transform: scale(1.05); }
      .btn-check:disabled, .btn-sold:disabled { background: var(--muted); cursor: not-allowed; filter: none; transform: none; }


      /* ==================== GRADER MODAL ==================== */
      #grader-modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: var(--bg-deep);
        border: 2px solid var(--primary);
        width: 95%;
        max-width: 1400px;
        height: 85vh;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        box-shadow: 0 0 50px rgba(34, 211, 238, 0.2);
      }
      .modal-header {
        background: var(--bg-header); padding: 15px; border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
      }
      .modal-title { color: var(--secondary); font-family: 'Consolas', monospace; font-weight: bold; }
      .close-btn { background: transparent; border: none; color: var(--danger); font-size: 24px; cursor: pointer; }
      .modal-body { padding: 0; overflow-y: auto; flex: 1; }

      table { width: 100%; border-collapse: collapse; }
      th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); color: var(--primary); font-family: 'Consolas', monospace; }
      td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
      .file-link { display: block; color: var(--primary); font-size: 12px; margin-bottom: 4px; text-decoration: none; }
      .file-link:hover { text-decoration: underline; }
      .grade-input { width: 60px; background: var(--bg-header); border: 1px solid var(--border); color: white; padding: 5px; text-align: center; }
      .btn-return { background: var(--success); color: #064e3b; border: none; padding: 5px 15px; font-size: 12px; border-radius: 4px; }
      .btn-return:hover { background: #6ee7b7; }
      .btn-return:disabled { background: var(--muted); cursor: not-allowed; }
      .row-success { background: rgba(52, 211, 153, 0.1); opacity: 0.6; }
      .mp-badge { font-size: 11px; background: var(--bg-header); color: var(--muted); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); }

      /* ==================== GRADER CARDS ==================== */
      .grader-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .grader-card {
        background: rgba(15, 23, 42, 0.9);
        border: 2px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
      }

      .grader-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(34, 211, 238, 0.2);
      }

      .grader-card.card-success {
        border-color: var(--success);
        opacity: 0.7;
      }

      .card-header {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-bottom: 1px solid var(--border);
      }

      .card-assignment-title {
        color: var(--secondary);
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
        font-family: 'Consolas', monospace;
      }

      .card-student-name {
        color: white;
        font-weight: bold;
        font-size: 16px;
      }

      .card-body {
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .card-section {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .card-label {
        font-family: 'Consolas', monospace;
        color: var(--primary);
        font-size: 11px;
        text-transform: uppercase;
        font-weight: bold;
      }

      .card-files {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .card-file-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 12px;
        padding: 4px 8px;
        background: rgba(34, 211, 238, 0.1);
        border-radius: 4px;
        border-left: 3px solid var(--primary);
        transition: 0.2s;
      }

      .card-file-link:hover {
        background: rgba(34, 211, 238, 0.2);
        padding-left: 12px;
      }

      .card-feedback-textarea {
        width: 100%;
        height: 60px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        color: white;
        padding: 8px;
        font-size: 12px;
        font-family: 'Verdana', sans-serif;
        border-radius: 4px;
        resize: vertical;
        box-sizing: border-box;
      }

      .card-feedback-textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      .card-grade-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-grade-input {
        width: 70px;
        background: var(--bg-deep);
        border: 2px solid var(--border);
        color: var(--secondary);
        padding: 8px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        font-family: 'Consolas', monospace;
        border-radius: 4px;
      }

      .card-grade-input:focus {
        outline: none;
        border-color: var(--secondary);
      }

      .card-max-points {
        font-size: 14px;
        color: var(--muted);
        font-family: 'Consolas', monospace;
      }

      .card-footer {
        padding: 0;
        position: relative;
      }

      .card-grade-btn {
        width: 100%;
        background: var(--success);
        color: #064e3b;
        border: none;
        padding: 15px;
        font-size: 14px;
        font-weight: bold;
        font-family: 'Consolas', monospace;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .card-grade-btn:hover {
        background: #6ee7b7;
        transform: scale(1.02);
      }

      .card-grade-btn:disabled {
        background: var(--muted);
        cursor: not-allowed;
        transform: none;
      }

      /* Progress Bar */
      .card-progress-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transition: width 0.3s ease;
        box-shadow: 0 0 10px var(--primary);
      }

      .card-progress-bar.active {
        animation: progressPulse 1.5s infinite;
      }

      @keyframes progressPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      /* Loading States */
      .card-grade-btn.loading::after {
        content: '';
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-left: 8px;
        border: 2px solid #064e3b;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    </style>
  </head>
  <body>

    <!-- ANIMATED BACKGROUND -->
    <div class="grid-bg-container theme-cyan" id="bg-layer">
      <div class="grid-gradient"></div>
      <div class="grid-lines"></div>
      <div class="grid-vignette"></div>
    </div>

    <!-- LOADING -->
    <div id="loading-screen" style="display:none;">
      <div class="spinner"></div>
    </div>

    <!-- GATE -->
    <div id="shrek-gate">
      <div class="shrek-container" onclick="switchAccount()">
        <img src="https://mtmsteam.org/wp-content/uploads/2026/01/noentry.png" class="shrek-img" alt="NO ENTRY">
        <div class="meme-text">6 - 7</div>
        <div class="gate-info">
          <div>System detected login as:</div>
          <div id="detected-email">...</div>
        </div>
        <div class="gate-hint">‚ñ∂ Click Shrek to Switch Accounts</div>
      </div>
    </div>

    <!-- MAIN NAV -->
    <nav class="main-nav" id="main-nav" style="display:flex;">
      <select id="class-select" onchange="handleClassChange()">
        <option value="" disabled selected>Select a class...</option>
      </select>

      <button class="nav-btn active" onclick="switchView('console')">üéì TEACHER CONSOLE</button>
      <button class="nav-btn" onclick="switchView('leaderboard')">üèÜ LEADERBOARD</button>
      <button class="nav-btn" onclick="switchView('auction')">‚öñÔ∏è AUCTION HOUSE</button>
      <button class="nav-btn" onclick="switchView('song')">üéµ SONG MANAGER</button>
      <button class="nav-btn" onclick="switchView('config')">‚öôÔ∏è CONFIG</button>
      <button class="nav-btn" onclick="switchView('bonus')">üéØ BONUS ROUND</button>
      <button class="nav-btn" onclick="switchView('overlord')">üéÆ OVERLORD</button>
      <button class="nav-btn" onclick="switchView('curriculum')">üìö CURRICULUM</button>
    </nav>

    <!-- VIEW: CONSOLE -->
    <div id="dashboard">
      <div class="header">
        <div>
          <div class="title">MMH CONSOLE</div>
          <div class="subtitle">Teacher Operations Center</div>
        </div>
        <div id="user-email" style="font-family: Consolas; font-size: 12px;"></div>
      </div>

      <div class="control-panel">
        <div class="row">
          <!-- Class Selector Moved to Nav -->
          <div class="col" style="justify-content: center;">
            <div style="font-size:12px; color:var(--muted);">
              Scans all assignments in internal database. Use the Global Nav to switch classes.
            </div>
          </div>
        </div>

        <div id="action-area">
          <button class="btn-secondary" onclick="runOrganizer()">üìÇ ORGANIZE PENDING FILES</button>
          <button class="btn-primary" onclick="openGrader()">‚ö° OPEN RAPID GRADER</button>
        </div>

        <div id="org-result"></div>
      </div>
    </div>

    <!-- VIEW: BONUS ROUND -->
    <div id="bonus-view" style="display:none; width:100%; max-width:1200px; padding:20px; height:85vh; flex-direction:column; gap:20px;">

      <!-- TOP: HUD -->
      <div style="background:rgba(0,0,0,0.8); border:2px solid #34d399; padding:20px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">

        <!-- Energy Bar -->
        <div style="flex:1; margin-right:30px;">
          <div style="display:flex; justify-content:space-between; color:#34d399; font-family:'Consolas'; font-weight:bold; margin-bottom:5px;">
            <span>CLASS ENERGY</span>
            <span id="bonus-hp-text">1000 / 1000</span>
          </div>
          <div style="width:100%; height:30px; background:#064e3b; border:1px solid #34d399; border-radius:15px; overflow:hidden; position:relative;">
            <div id="bonus-hp-fill" style="width:100%; height:100%; background:linear-gradient(90deg, #34d399, #10b981); transition:width 0.5s;"></div>
          </div>
        </div>

        <!-- Stats -->
        <div style="display:flex; gap:20px;">
          <div style="text-align:center;">
            <div style="font-size:12px; color:#9ca3af;">STREAK</div>
            <div id="bonus-streak" style="font-size:24px; font-weight:bold; color:#fbbf24; font-family:'Consolas';">0</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:12px; color:#9ca3af;">ROUND</div>
            <div id="bonus-round" style="font-size:24px; font-weight:bold; color:#22d3ee; font-family:'Consolas';">-</div>
          </div>
        </div>

      </div>

      <!-- MIDDLE: GAME BOARD -->
      <div style="flex:1; background:rgba(15, 23, 42, 0.9); border:1px solid #334155; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; position:relative; overflow:hidden;" id="bonus-board">
        <canvas id="particle-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>

        <div id="bonus-question-text" style="font-size:32px; font-weight:bold; text-align:center; color:white; z-index:10; max-width:800px; text-shadow:0 0 10px black;">
          WAITING TO START
        </div>

        <div id="bonus-status-msg" style="margin-top:20px; font-family:'Consolas'; color:#34d399; z-index:10;"></div>
      </div>

      <!-- BOTTOM: CONTROLS -->
      <div style="display:flex; gap:10px; justify-content:center;">
        <button class="btn-primary" onclick="initBonusGame()" style="background:#34d399; color:#064e3b; padding:15px 30px;">‚ö° INITIALIZE GAME</button>
        <button class="btn-secondary" onclick="postBonusLink()" id="btn-bonus-link" disabled>üîó POST LINK</button>
        <button class="btn-secondary" onclick="startBonusRound()" id="btn-bonus-start" disabled>‚ñ∂ START</button>
        <button class="btn-secondary" onclick="nextBonusQuestion()" id="btn-bonus-next" disabled>‚è≠ NEXT QUESTION</button>
        <button class="btn-secondary" onclick="stopBonusGame()" style="border-color:#f87171; color:#f87171;">üõë END GAME</button>
      </div>

    </div>

    <!-- VIEW: SONG MANAGER -->
    <div id="song-manager-view">
      <div class="song-flex">
        <!-- PENDING -->
        <div class="song-col">
          <div class="song-header">
             <span>INBOX (PENDING)</span>
             <button onclick="loadSongManager()" style="background:none; border:none; color:inherit; cursor:pointer;">‚Üª</button>
          </div>
          <div class="song-list" id="song-inbox">
            Loading...
          </div>
        </div>

        <!-- STAGED -->
        <div class="song-col">
          <div class="song-header">
            <span>DAILY PLAYLIST (<span id="playlist-period-label">...</span>)</span>
          </div>
          <div class="song-list" id="song-playlist">
            Loading...
          </div>

          <div class="playlist-actions">
             <button class="btn-finalize" onclick="finalizePlaylist()" id="btn-finalize-playlist" disabled>üöÄ FINALIZE PLAYLIST</button>
             <div id="playlist-result" style="margin-top:10px; font-size:12px; color:var(--success);"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: LEADERBOARD -->
    <div id="leaderboard-view">
      <div class="rpg-header">
        <img src="https://multimediaheroes.com/multimediaheroesassets/mmhlogowide.webp" class="rpg-logo">
      </div>

      <div class="rpg-filters">
        <select id="lb-period" class="rpg-select" onchange="renderLeaderboard()">
          <option value="ALL">All Periods</option>
          <option value="1">Period 1</option>
          <option value="2">Period 2</option>
          <option value="3">Period 3</option>
          <option value="4">Period 4</option>
          <option value="5">Period 5</option>
          <option value="6">Period 6</option>
        </select>

        <div class="studio-tabs">
          <button class="studio-tab active" onclick="setStudio('ALL', this)">ALL</button>
          <button class="studio-tab" onclick="setStudio('Sound', this)">SOUND</button>
          <button class="studio-tab" onclick="setStudio('Visual', this)">VISUAL</button>
          <button class="studio-tab" onclick="setStudio('Interactive', this)">INTERACTIVE</button>
        </div>
      </div>

      <div class="rpg-grid">
        <!-- Weekly -->
        <div class="rpg-panel">
          <div class="panel-title">‚ö° THIS WEEK'S HEROES</div>
          <ul class="rpg-list" id="lb-weekly">
            <li class="rpg-item" style="justify-content:center; color:var(--muted);">Loading...</li>
          </ul>
        </div>

        <!-- All Time -->
        <div class="rpg-panel">
          <div class="panel-title">üëë HALL OF FAME</div>
          <ul class="rpg-list" id="lb-alltime">
            <li class="rpg-item" style="justify-content:center; color:var(--muted);">Loading...</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- VIEW: AUCTION -->
    <div id="auction-view">
      <div class="auction-flex">
        <!-- LEFT: Items -->
        <div class="item-grid-container" id="item-grid">
          <div style="color:var(--muted); text-align:center; padding:20px;">Loading Items...</div>
        </div>

        <!-- RIGHT: Desk -->
        <div class="auction-desk">
          <div class="desk-header">
            <div class="desk-title">AUCTIONEER DESK</div>
            <div class="desk-subtitle">Select Item &bull; Find Student &bull; Bid</div>
          </div>

          <div class="desk-section">
            <label class="desk-label">Selected Lot</label>
            <div id="selected-item-display" style="color:white; font-weight:bold; font-size:18px;">(None Selected)</div>
          </div>

          <div class="desk-section">
            <label class="desk-label">Period</label>
            <select id="auction-period" onchange="filterStudentList()">
              <option value="1">Period 1</option>
              <option value="2">Period 2</option>
              <option value="3">Period 3</option>
              <option value="4">Period 4</option>
              <option value="5">Period 5</option>
              <option value="6">Period 6</option>
            </select>
          </div>

          <div class="desk-section">
            <label class="desk-label">Student</label>
            <div class="student-search-box">
              <input type="text" id="student-search-input" placeholder="Type Name..." autocomplete="off">
              <div id="search-results"></div>
            </div>
            <input type="hidden" id="selected-student-email">
          </div>

          <div class="desk-section">
            <label class="desk-label">Bid Amount</label>
            <div class="bid-area">
              <input type="number" id="bid-input" placeholder="0">
              <span style="color:var(--secondary); font-weight:bold;">TC</span>
            </div>
          </div>

          <div class="feedback-box" id="feedback-display">
            READY TO START
          </div>

          <div class="action-btns">
            <button class="btn-check" onclick="checkBid()">CHECK BID</button>
            <button class="btn-sold" onclick="finalizeBid()" disabled id="btn-finalize">SOLD!</button>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: CONFIG -->
    <div id="config-tab" style="display: none; width: 100%; max-width: 1000px; padding: 20px;">
      <div style="background: rgba(15, 23, 42, 0.9); padding: 25px; border-radius: 8px; border: 1px solid var(--border); backdrop-filter: blur(5px);">
        <h2 style="color: var(--primary); font-family: 'Consolas', monospace; margin-top: 0;">‚öôÔ∏è Student Matching Config</h2>
        <p style="color: var(--muted); margin-bottom: 20px;">
          Resolve students that couldn't be automatically matched. Select a roster student for each, then click Finalize.
        </p>

        <!-- Unmatched Students Section -->
        <div style="margin-bottom: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: var(--secondary);">‚ùå Unmatched Students</h3>
            <div>
              <button onclick="loadUnmatchedStudents()" class="btn-secondary">üîÑ Refresh</button>
              <button onclick="finalizeAllOverrides()" class="btn-primary" id="finalize-btn" style="display: none;">
                üíæ Finalize All (<span id="pending-count">0</span>)
              </button>
            </div>
          </div>
          <div id="unmatched-list" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 10px; border-radius: 4px;">
            <p style="color: var(--muted); font-style: italic;">Click refresh to load unmatched students...</p>
          </div>
        </div>

        <!-- Current Overrides Section -->
        <div>
          <h3 style="margin-bottom: 10px; color: var(--success);">‚úÖ Manual Overrides</h3>
          <div id="overrides-list" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 10px; border-radius: 4px;">
            <p style="color: var(--muted); font-style: italic;">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: OVERLORD -->
    <div id="overlord-view" style="display: none; width: 100%; max-width: 1200px; padding: 20px;">
      <div class="header" style="border-color: #22d3ee;">
        <div>
          <div class="title">üéÆ MMH OVERLORD</div>
          <div class="subtitle">Plugin Gateway & Student Management</div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn-secondary" onclick="loadOverlordData()">üîÑ REFRESH</button>
        </div>
      </div>

      <!-- Overlord Tabs -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="overlord-tab active" onclick="switchOverlordTab('skeys')">üîë SKEY DEPLOYMENT</button>
        <button class="overlord-tab" onclick="switchOverlordTab('test')">üß™ TEST STUDENTS</button>
        <button class="overlord-tab" onclick="switchOverlordTab('manage')">‚öôÔ∏è MANAGE STUDENTS</button>
      </div>

      <!-- SKEY Deployment Tab -->
      <div id="overlord-skeys" class="control-panel">
        <h3 style="color: var(--primary); margin-top: 0;">üîë Deploy Skeys by Period</h3>
        <p style="color: var(--muted); margin-bottom: 20px;">
          Generate and share .skey files with students in Google Drive. Skeys are anonymous tokens for plugin authentication.
        </p>

        <div class="row">
          <div class="col">
            <label>Select Period</label>
            <select id="overlord-period-select">
              <option value="">Choose period...</option>
              <option value="3">Period 3</option>
              <option value="4">Period 4</option>
              <option value="5">Period 5</option>
              <option value="6">Period 6</option>
              <option value="7">Period 7</option>
            </select>
          </div>
          <div class="col" style="justify-content: flex-end;">
            <button class="btn-primary" onclick="deploySkeysPeriod()">üöÄ DEPLOY SKEYS</button>
          </div>
        </div>

        <div id="skey-result" style="margin-top: 15px;"></div>

        <h4 style="color: var(--secondary); margin-top: 30px;">üìä Deployment Status</h4>
        <div id="deployment-status" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 4px; border: 1px solid var(--border);">
          <p style="color: var(--muted); font-style: italic;">Loading...</p>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
          <label style="margin: 0;">SafeSearch (YouTube):</label>
          <span id="safesearch-status" style="color: var(--success); font-weight: bold;">ON</span>
          <button class="btn-secondary" onclick="toggleSafeSearch()">Toggle</button>
        </div>
      </div>

      <!-- Test Students Tab -->
      <div id="overlord-test" class="control-panel" style="display: none;">
        <h3 style="color: var(--primary); margin-top: 0;">üß™ Test Students</h3>
        <p style="color: var(--muted); margin-bottom: 20px;">
          Create test accounts with external emails (e.g., Gmail) for demos. No Classroom integration.
        </p>

        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 20px;">
          <h4 style="margin-top: 0; color: var(--secondary);">‚ûï Add Test Student</h4>
          <div class="row">
            <div class="col">
              <label>Display Name</label>
              <input type="text" id="test-name" placeholder="e.g., Demo User">
            </div>
            <div class="col">
              <label>Email</label>
              <input type="email" id="test-email" placeholder="e.g., jasonbermanjazz@gmail.com">
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Period (for organization)</label>
              <select id="test-period">
                <option value="Test">Test</option>
                <option value="Demo">Demo</option>
                <option value="3">Period 3</option>
                <option value="4">Period 4</option>
                <option value="5">Period 5</option>
                <option value="6">Period 6</option>
                <option value="7">Period 7</option>
              </select>
            </div>
            <div class="col">
              <label>Notes (optional)</label>
              <input type="text" id="test-notes" placeholder="e.g., District demo account">
            </div>
          </div>
          <button class="btn-primary" onclick="createTestStudent()" style="margin-top: 10px;">‚ûï CREATE TEST STUDENT</button>
          <div id="test-create-result" style="margin-top: 10px;"></div>
        </div>

        <h4 style="color: var(--secondary);">üìã Existing Test Students</h4>
        <div id="test-students-list" style="max-height: 400px; overflow-y: auto;">
          <p style="color: var(--muted); font-style: italic;">Loading...</p>
        </div>
      </div>

      <!-- Manage Students Tab -->
      <div id="overlord-manage" class="control-panel" style="display: none;">
        <h3 style="color: var(--primary); margin-top: 0;">‚öôÔ∏è Manage Students</h3>
        <p style="color: var(--muted); margin-bottom: 20px;">
          View and adjust MP/inventory for any student (regular or test).
        </p>

        <div class="row">
          <div class="col">
            <label>Search by Token or Email</label>
            <input type="text" id="manage-search" placeholder="Type to search..." oninput="searchStudentsManage()">
          </div>
        </div>

        <div id="manage-search-results" style="margin-top: 15px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; display: none;">
        </div>

        <!-- Selected Student Panel -->
        <div id="manage-student-panel" style="display: none; margin-top: 20px; background: rgba(34, 211, 238, 0.1); border: 2px solid var(--primary); padding: 20px; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              <h4 style="margin: 0; color: var(--primary);">
                <span id="manage-student-token"></span>
                <span id="manage-test-badge" style="background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px; display: none;">TEST</span>
              </h4>
              <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 12px;">Period: <span id="manage-student-period"></span></p>
            </div>
            <div style="text-align: right;">
              <div style="color: var(--secondary); font-size: 24px; font-family: 'Consolas', monospace; font-weight: bold;">
                <span id="manage-student-balance">0</span> TC
              </div>
              <div style="font-size: 11px; color: var(--muted);">Timmy Coins</div>
            </div>
          </div>

          <!-- MP Adjustment -->
          <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <h5 style="margin-top: 0; color: var(--secondary);">üí∞ Adjust MP</h5>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
              <div style="flex: 0 0 100px;">
                <label>Amount</label>
                <input type="number" id="manage-mp-amount" value="10" style="width: 100%;">
              </div>
              <div style="flex: 1;">
                <label>Reason</label>
                <input type="text" id="manage-mp-reason" placeholder="e.g., Bonus for helping" style="width: 100%;">
              </div>
              <button class="btn-primary" onclick="adjustMP(1)" style="background: var(--success);">+ ADD</button>
              <button class="btn-secondary" onclick="adjustMP(-1)" style="border-color: var(--danger); color: var(--danger);">- REMOVE</button>
            </div>
            <div id="manage-mp-result" style="margin-top: 10px;"></div>
          </div>

          <!-- Inventory -->
          <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 4px;">
            <h5 style="margin-top: 0; color: var(--secondary);">üì¶ Inventory</h5>
            <div id="manage-inventory-list" style="margin-bottom: 15px;">
              <p style="color: var(--muted); font-style: italic;">No items</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
              <div style="flex: 1;">
                <label>Item Name</label>
                <input type="text" id="manage-inv-item" placeholder="e.g., Song Request" style="width: 100%;">
              </div>
              <div style="flex: 0 0 80px;">
                <label>Qty</label>
                <input type="number" id="manage-inv-qty" value="1" min="1" style="width: 100%;">
              </div>
              <button class="btn-primary" onclick="adjustInventory(1)">+ ADD</button>
              <button class="btn-secondary" onclick="adjustInventory(-1)" style="border-color: var(--danger); color: var(--danger);">- REMOVE</button>
            </div>
            <div id="manage-inv-result" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: CURRICULUM BUILDER -->
    <div id="curriculum-view" style="display: none; width: 100%; max-width: 1400px; padding: 20px;">
      <div class="curriculum-header">
        <h2>üìö CURRICULUM BUILDER</h2>
        <div style="display: flex; gap: 10px;">
          <button class="btn-primary" onclick="showAddTrackModal()">+ NEW TRACK</button>
          <button class="btn-secondary" onclick="refreshCurriculumData()">üîÑ REFRESH</button>
        </div>
      </div>

      <div class="curriculum-tabs">
        <button class="curriculum-tab active" onclick="switchCurriculumTab('builder')">üèóÔ∏è BUILDER</button>
        <button class="curriculum-tab" onclick="switchCurriculumTab('achievements')">üìñ ACHIEVEMENTS</button>
        <button class="curriculum-tab" onclick="switchCurriculumTab('events')">üìÖ EVENTS</button>
        <button class="curriculum-tab" onclick="switchCurriculumTab('publish')">üöÄ PUBLISH</button>
        <button class="curriculum-tab" onclick="switchCurriculumTab('forms')">üìù FORMS</button>
        <button class="curriculum-tab" onclick="switchCurriculumTab('history')">üìú HISTORY</button>
      </div>

      <!-- TAB: Builder -->
      <div id="curriculum-builder-tab">
        <div id="curriculum-loading" style="text-align: center; padding: 40px; display: none;">
          <div class="spinner" style="margin: 0 auto 15px;"></div>
          <p>Loading curriculum data...</p>
        </div>

        <div id="studios-container" class="studio-cards">
          <!-- Studios will be rendered here dynamically -->
        </div>
      </div>

      <!-- TAB: Achievements -->
      <div id="curriculum-achievements-tab" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: var(--secondary); margin: 0;">üìñ Achievement Details</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn-secondary" onclick="showImportAchievementsModal()">üì• IMPORT JSON</button>
            <button class="btn-primary" onclick="showAddAchievementModal()">+ NEW ACHIEVEMENT</button>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <input type="text" id="achievement-search" placeholder="Search achievements by ID, title, or track..."
            style="width: 100%; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: #fff; font-size: 14px;"
            oninput="filterAchievements(this.value)">
        </div>

        <div id="achievements-list" style="display: grid; gap: 15px;">
          <p style="color: var(--muted); text-align: center; padding: 40px;">Loading achievements...</p>
        </div>
      </div>

      <!-- TAB: Events -->
      <div id="curriculum-events-tab" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: var(--secondary); margin: 0;">üìÖ Special Events</h3>
          <button class="btn-primary" onclick="showAddEventModal()">+ NEW EVENT</button>
        </div>

        <div id="events-list">
          <!-- Events will be rendered here -->
          <p style="color: var(--muted); text-align: center; padding: 40px;">No events found. Create your first special event!</p>
        </div>
      </div>

      <!-- TAB: Publish -->
      <div id="curriculum-publish-tab" style="display: none;">
        <h3 style="color: var(--success); margin-bottom: 20px;">üöÄ Publish to Google Classroom</h3>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: rgba(52, 211, 153, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 20px; text-align: center;">
            <div style="font-size: 36px; color: var(--success); font-weight: bold;" id="publish-ready-count">0</div>
            <div style="color: var(--muted); font-size: 12px; text-transform: uppercase;">Ready to Publish</div>
          </div>
          <div style="background: rgba(34, 211, 238, 0.1); border: 1px solid var(--primary); border-radius: 8px; padding: 20px; text-align: center;">
            <div style="font-size: 36px; color: var(--primary); font-weight: bold;" id="publish-pending-count">0</div>
            <div style="color: var(--muted); font-size: 12px; text-transform: uppercase;">Pending</div>
          </div>
          <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--secondary); border-radius: 8px; padding: 20px; text-align: center;">
            <div style="font-size: 36px; color: var(--secondary); font-weight: bold;" id="publish-completed-count">0</div>
            <div style="color: var(--muted); font-size: 12px; text-transform: uppercase;">Published</div>
          </div>
        </div>

        <div id="publish-progress-container" style="display: none;">
          <p style="margin-bottom: 10px; color: var(--primary);">Publishing to Classroom...</p>
          <div class="publish-progress">
            <div class="publish-progress-bar" id="publish-progress-bar" style="width: 0%;">0%</div>
          </div>
          <p id="publish-status" style="font-size: 12px; color: var(--muted);"></p>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="btn-primary" onclick="publishAllReady()" id="publish-all-btn">üöÄ PUBLISH ALL READY</button>
          <button class="btn-secondary" onclick="refreshPublishQueue()">üîÑ REFRESH QUEUE</button>
        </div>

        <div id="publish-queue-list">
          <!-- Publish queue items will be rendered here -->
        </div>
      </div>

      <!-- TAB: Forms -->
      <div id="curriculum-forms-tab" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: var(--primary); margin: 0;">üìù Track Selection Forms</h3>
          <button class="btn-primary" onclick="createNewTrackForm()">+ CREATE FORM</button>
        </div>

        <p style="color: var(--muted); margin-bottom: 20px;">
          Track selection forms allow students to choose their Level 0 starting tracks. Create multiple forms for different periods or cohorts.
        </p>

        <div id="forms-list">
          <!-- Forms will be rendered here -->
          <div style="background: rgba(255,255,255,0.02); border: 2px dashed var(--border); border-radius: 8px; padding: 40px; text-align: center;">
            <p style="color: var(--muted);">No forms created yet.</p>
            <button class="btn-primary" style="margin-top: 15px;" onclick="createNewTrackForm()">Create Your First Form</button>
          </div>
        </div>
      </div>

      <!-- TAB: History -->
      <div id="curriculum-history-tab" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: var(--warning); margin: 0;">üìú Change History</h3>
          <button class="btn-secondary" onclick="refreshHistory()">üîÑ REFRESH</button>
        </div>

        <p style="color: var(--muted); margin-bottom: 20px;">
          All curriculum changes are logged here. You can undo individual changes (except Classroom publishing).
        </p>

        <div id="history-list" style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
          <!-- History items will be rendered here -->
          <div class="history-item" style="justify-content: center; color: var(--muted);">
            No changes recorded yet.
          </div>
        </div>
      </div>
    </div>

    <!-- CURRICULUM MODALS -->
    <div id="track-modal" class="curriculum-modal" style="display: none;">
      <div class="curriculum-modal-content">
        <h3>‚ûï Add New Track</h3>
        <div class="form-group">
          <label>Track Code (2-5 letters)</label>
          <input type="text" id="track-code-input" placeholder="e.g., SF, VID, INT" maxlength="5" style="text-transform: uppercase;">
        </div>
        <div class="form-group">
          <label>Track Name</label>
          <input type="text" id="track-name-input" placeholder="e.g., Sound Factory">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Studio</label>
            <select id="track-studio-input">
              <option value="Sound">üéß Sound</option>
              <option value="Visual">üé® Visual</option>
              <option value="Interactive">üéÆ Interactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Starting Level</label>
            <select id="track-level-input">
              <option value="0">Level 0 (Gateway)</option>
              <option value="1">Level 1</option>
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Track Type</label>
            <select id="track-type-input">
              <option value="Power">Power Track</option>
              <option value="Theory">Theory Track</option>
              <option value="Hero Trial">Hero Trial</option>
            </select>
          </div>
          <div class="form-group">
            <label>Unlock MP Requirement</label>
            <input type="number" id="track-unlock-mp-input" value="160">
          </div>
        </div>
        <div class="form-group">
          <label>Prerequisites (optional)</label>
          <input type="text" id="track-prereq-input" placeholder="e.g., SF-L0">
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeTrackModal()">Cancel</button>
          <button class="btn-primary" onclick="saveNewTrack()">Create Track</button>
        </div>
      </div>
    </div>

    <div id="assignment-modal" class="curriculum-modal" style="display: none;">
      <div class="curriculum-modal-content">
        <h3>‚ûï Add New Assignment</h3>
        <input type="hidden" id="assignment-track-code">
        <input type="hidden" id="assignment-track-name">
        <input type="hidden" id="assignment-studio">
        <input type="hidden" id="assignment-level">
        <div class="form-group">
          <label>Assignment Title</label>
          <input type="text" id="assignment-title-input" placeholder="e.g., Introduction to Sound Waves">
        </div>
        <div class="form-group">
          <label>Initial Achievements (one per line)</label>
          <textarea id="assignment-achievements-input" rows="5" placeholder="Complete the tutorial video&#10;Answer the quiz questions&#10;Submit your first recording"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Default MP per Achievement</label>
            <input type="number" id="assignment-default-mp" value="10">
          </div>
          <div class="form-group">
            <label>Assignment Number</label>
            <input type="number" id="assignment-num-input" value="1" min="1">
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeAssignmentModal()">Cancel</button>
          <button class="btn-primary" onclick="saveNewAssignment()">Create Assignment</button>
        </div>
      </div>
    </div>

    <div id="achievement-modal" class="curriculum-modal" style="display: none;">
      <div class="curriculum-modal-content">
        <h3>‚úèÔ∏è Edit Achievement</h3>
        <input type="hidden" id="edit-achievement-row">
        <div class="form-group">
          <label>Achievement ID</label>
          <input type="text" id="edit-achievement-id" readonly style="opacity: 0.7;">
        </div>
        <div class="form-group">
          <label>Achievement Name</label>
          <input type="text" id="edit-achievement-name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>MP Value</label>
            <input type="number" id="edit-achievement-mp" min="1">
          </div>
          <div class="form-group">
            <label>Resource Type</label>
            <select id="edit-achievement-resource-type">
              <option value="None">None</option>
              <option value="YouTube">YouTube Video</option>
              <option value="Link">External Link</option>
              <option value="File">File Attachment</option>
              <option value="Google Doc">Google Doc</option>
              <option value="Google Slides">Google Slides</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Resource URL</label>
          <input type="text" id="edit-achievement-url" placeholder="https://...">
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeAchievementModal()">Cancel</button>
          <button class="btn-primary" onclick="saveAchievementEdits()">Save Changes</button>
        </div>
      </div>
    </div>

    <div id="event-modal" class="curriculum-modal" style="display: none;">
      <div class="curriculum-modal-content" style="max-width: 680px;">
        <h3 style="margin-bottom: 8px;">üìÖ Create Special Event</h3>
        <div style="background: linear-gradient(135deg, var(--success), #2ecc71); color: #fff; padding: 5px 12px; border-radius: 12px; display: inline-block; margin-bottom: 12px; font-size: 10px; font-weight: bold;">
          üåç OPEN TO ALL STUDENTS
        </div>
        <div class="form-row" style="gap: 10px;">
          <div class="form-group" style="flex: 2;">
            <label style="font-size: 11px;">Event Name</label>
            <input type="text" id="event-name-input" placeholder="e.g., Holiday Challenge" style="padding: 6px 8px;">
          </div>
          <div class="form-group" style="flex: 1;">
            <label style="font-size: 11px;">Track Code</label>
            <input type="text" id="event-track-code-input" placeholder="holiday24" style="text-transform: lowercase; padding: 6px 8px;">
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
          <label style="font-size: 11px;">Description</label>
          <textarea id="event-desc-input" rows="2" placeholder="Describe this special event..." style="font-size: 11px; padding: 6px 8px;"></textarea>
        </div>
        <div class="form-row" style="gap: 8px;">
          <div class="form-group"><label style="font-size: 11px;">Start</label><input type="date" id="event-start-input" style="padding: 4px;"></div>
          <div class="form-group"><label style="font-size: 11px;">End</label><input type="date" id="event-end-input" style="padding: 4px;"></div>
          <div class="form-group"><label style="font-size: 11px;">Bonus Days</label><input type="number" id="event-bonus-days-input" value="7" min="1" max="30" style="width: 50px; padding: 4px;"></div>
        </div>

        <h4 style="color: var(--secondary); margin: 12px 0 6px; font-size: 13px;">üèÜ Victory Tiers</h4>

        <div style="display: flex; gap: 6px;">
          <!-- Tier 1: Bronze -->
          <div style="flex: 1; background: linear-gradient(145deg, #cd7f32, #8b5a2b); border-radius: 8px; padding: 8px; color: #fff;">
            <div style="text-align: center; font-size: 14px;">ü•â <span style="font-size: 10px; font-weight: bold;">BRONZE</span></div>
            <div style="margin-top: 6px;">
              <label style="font-size: 8px; color: #fff;">Reach MP</label>
              <input type="number" id="event-t1-threshold" value="50" style="width: 100%; padding: 3px; font-size: 11px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: #fff;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 4px;">
              <div><label style="font-size: 8px; color: #fff;">+MP</label><input type="number" id="event-t1-mp" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: #fff;"></div>
              <div><label style="font-size: 8px; color: #fff;">+Coins</label><input type="number" id="event-t1-coins" value="10" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: #fff;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 4px;">
              <div><label style="font-size: 8px; color: #fff;">MP+%</label><input type="number" id="event-t1-mp-bonus" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: #fff;"></div>
              <div><label style="font-size: 8px; color: #fff;">Coin+%</label><input type="number" id="event-t1-coin-bonus" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: #fff;"></div>
            </div>
            <div style="margin-top: 4px;"><label style="font-size: 8px; color: #fff;">Loot</label><select id="event-t1-loot" style="width: 100%; padding: 2px; font-size: 9px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: #fff;"><option value="">None</option></select></div>
          </div>

          <!-- Tier 2: Silver -->
          <div style="flex: 1; background: linear-gradient(145deg, #c0c0c0, #808080); border-radius: 8px; padding: 8px; color: #1a1a2e;">
            <div style="text-align: center; font-size: 14px;">ü•à <span style="font-size: 10px; font-weight: bold;">SILVER</span></div>
            <div style="margin-top: 6px;">
              <label style="font-size: 8px; color: #1a1a2e;">Reach MP</label>
              <input type="number" id="event-t2-threshold" value="100" style="width: 100%; padding: 3px; font-size: 11px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 4px;">
              <div><label style="font-size: 8px; color: #1a1a2e;">+MP</label><input type="number" id="event-t2-mp" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
              <div><label style="font-size: 8px; color: #1a1a2e;">+Coins</label><input type="number" id="event-t2-coins" value="25" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 4px;">
              <div><label style="font-size: 8px; color: #1a1a2e;">MP+%</label><input type="number" id="event-t2-mp-bonus" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
              <div><label style="font-size: 8px; color: #1a1a2e;">Coin+%</label><input type="number" id="event-t2-coin-bonus" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
            </div>
            <div style="margin-top: 4px;"><label style="font-size: 8px; color: #1a1a2e;">Loot</label><select id="event-t2-loot" style="width: 100%; padding: 2px; font-size: 9px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"><option value="">None</option></select></div>
          </div>

          <!-- Tier 3: Gold -->
          <div style="flex: 1; background: linear-gradient(145deg, #ffd700, #b8860b); border-radius: 8px; padding: 8px; color: #1a1a2e;">
            <div style="text-align: center; font-size: 14px;">ü•á <span style="font-size: 10px; font-weight: bold;">GOLD</span></div>
            <div style="margin-top: 6px;">
              <label style="font-size: 8px; color: #1a1a2e;">Reach MP</label>
              <input type="number" id="event-t3-threshold" value="150" style="width: 100%; padding: 3px; font-size: 11px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 4px;">
              <div><label style="font-size: 8px; color: #1a1a2e;">+MP</label><input type="number" id="event-t3-mp" value="0" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
              <div><label style="font-size: 8px; color: #1a1a2e;">+Coins</label><input type="number" id="event-t3-coins" value="50" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 4px;">
              <div><label style="font-size: 8px; color: #1a1a2e;">MP+%</label><input type="number" id="event-t3-mp-bonus" value="5" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
              <div><label style="font-size: 8px; color: #1a1a2e;">Coin+%</label><input type="number" id="event-t3-coin-bonus" value="5" style="width: 100%; padding: 2px; font-size: 10px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"></div>
            </div>
            <div style="margin-top: 4px;"><label style="font-size: 8px; color: #1a1a2e;">Loot</label><select id="event-t3-loot" style="width: 100%; padding: 2px; font-size: 9px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; color: #1a1a2e;"><option value="">None</option><option value="Mystery Box" selected>Mystery Box</option></select></div>
          </div>
        </div>

        <div class="modal-actions" style="margin-top: 12px;">
          <button class="btn-secondary" onclick="closeEventModal()">Cancel</button>
          <button class="btn-primary" onclick="saveNewEvent()">Create Event</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Import Achievements JSON -->
    <div id="import-achievements-modal" class="curriculum-modal" style="display: none;">
      <div class="curriculum-modal-content" style="max-width: 700px;">
        <h3 style="margin-bottom: 15px;">üì• Import Achievements from JSON</h3>
        <p style="color: var(--muted); font-size: 12px; margin-bottom: 15px;">
          Paste your achievement JSON data below. Expected format:<br>
          <code style="background: var(--bg-deep); padding: 2px 6px; border-radius: 4px; font-size: 10px;">{ "cf-L0-a1-1": { "title": "...", "description": "...", "pitfalls": "...", "tools": "...", "videoUrl": null, "links": [] }, ... }</code>
        </p>
        <textarea id="import-json-textarea" rows="12" placeholder='Paste your JSON here...'
          style="width: 100%; font-family: monospace; font-size: 11px; background: var(--bg-deep); border: 1px solid var(--border); border-radius: 8px; color: #fff; padding: 12px;"></textarea>
        <div id="import-preview" style="margin-top: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px; display: none;">
          <span style="color: var(--muted);">Preview: </span><span id="import-preview-count">0</span> achievements detected
        </div>
        <div class="modal-actions" style="margin-top: 15px;">
          <button class="btn-secondary" onclick="closeImportModal()">Cancel</button>
          <button class="btn-secondary" onclick="previewImport()">Preview</button>
          <button class="btn-primary" onclick="executeImport()">Import All</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Achievement Editor with WYSIWYG -->
    <div id="achievement-editor-modal" class="curriculum-modal" style="display: none;">
      <div class="curriculum-modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 5px;">üìñ <span id="ach-editor-title">Edit Achievement</span></h3>
        <div style="color: var(--muted); font-size: 11px; margin-bottom: 15px;" id="ach-editor-id">ID: ‚Äî</div>

        <div class="form-row" style="gap: 15px; margin-bottom: 15px;">
          <div class="form-group" style="flex: 2;">
            <label>Achievement ID</label>
            <input type="text" id="ach-id-input" placeholder="e.g., cf-L0-a1-1" style="font-family: monospace;">
          </div>
          <div class="form-group" style="flex: 3;">
            <label>Title</label>
            <input type="text" id="ach-title-input" placeholder="Achievement title...">
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
          <label>Description (HTML supported)</label>
          <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
            <!-- WYSIWYG Toolbar -->
            <div style="background: var(--bg-deep); padding: 8px; display: flex; gap: 5px; flex-wrap: wrap; border-bottom: 1px solid var(--border);">
              <button type="button" onclick="wysiwygCmd('bold')" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;" title="Bold"><b>B</b></button>
              <button type="button" onclick="wysiwygCmd('italic')" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;" title="Italic"><i>I</i></button>
              <button type="button" onclick="wysiwygCmd('underline')" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;" title="Underline"><u>U</u></button>
              <span style="border-left: 1px solid var(--border); margin: 0 5px;"></span>
              <button type="button" onclick="wysiwygCmd('insertUnorderedList')" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;" title="Bullet List">‚Ä¢ List</button>
              <button type="button" onclick="wysiwygCmd('insertOrderedList')" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;" title="Numbered List">1. List</button>
              <span style="border-left: 1px solid var(--border); margin: 0 5px;"></span>
              <button type="button" onclick="wysiwygInsertLink()" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;" title="Insert Link">üîó Link</button>
              <select onchange="wysiwygColor(this.value); this.selectedIndex=0;" style="padding: 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: #fff; cursor: pointer;">
                <option value="">Color</option>
                <option value="#01d9f5">Cyan</option>
                <option value="#fcf203">Yellow</option>
                <option value="#bc14b0">Pink</option>
                <option value="#34d399">Green</option>
                <option value="#f87171">Red</option>
              </select>
              <span style="border-left: 1px solid var(--border); margin: 0 5px;"></span>
              <button type="button" onclick="toggleHtmlView()" style="padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--muted); cursor: pointer; font-size: 10px;" id="html-toggle-btn">&lt;/&gt; HTML</button>
            </div>
            <!-- Editable Area -->
            <div id="ach-description-editor" contenteditable="true"
              style="min-height: 150px; padding: 15px; background: var(--bg-card); color: #fff; font-size: 13px; line-height: 1.6; outline: none;"
              oninput="syncDescriptionToTextarea()"></div>
            <!-- Hidden textarea for raw HTML -->
            <textarea id="ach-description-raw" style="display: none; width: 100%; min-height: 150px; font-family: monospace; font-size: 11px; background: var(--bg-deep); color: #0f0; border: none; padding: 15px;"></textarea>
          </div>
        </div>

        <div class="form-row" style="gap: 15px; margin-bottom: 15px;">
          <div class="form-group" style="flex: 1;">
            <label>Pitfalls / Common Mistakes</label>
            <textarea id="ach-pitfalls-input" rows="3" placeholder="What students often get wrong..."></textarea>
          </div>
          <div class="form-group" style="flex: 1;">
            <label>Tools Used</label>
            <input type="text" id="ach-tools-input" placeholder="e.g., Construct 3, Photoshop">
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
          <label>Video URL (optional)</label>
          <input type="url" id="ach-video-input" placeholder="https://youtube.com/watch?v=...">
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
          <label>Links (JSON array)</label>
          <textarea id="ach-links-input" rows="2" placeholder='[{"title": "Resource", "url": "https://..."}]' style="font-family: monospace; font-size: 11px;"></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeAchievementEditorModal()">Cancel</button>
          <button class="btn-danger" onclick="deleteCurrentAchievement()" id="ach-delete-btn" style="display: none;">Delete</button>
          <button class="btn-primary" onclick="saveAchievementFromEditor()">Save Achievement</button>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div id="grader-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">RAPID GRADER <span id="modal-subtitle"></span></div>
          <button class="close-btn" onclick="closeGrader()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="grader-loading" style="text-align:center; padding:20px; display:none;">
            <div class="spinner" style="margin:0 auto;"></div>
            <p>Scanning all assignments for submissions...</p>
            <p style="font-size:12px; color:var(--muted);">This may take a moment.</p>
          </div>
          <div id="grader-empty" style="text-align:center; padding:20px; display:none; color:var(--muted);">
            üéâ No pending work found in this class!
          </div>
          <div class="grader-cards-container" id="grader-cards"></div>
        </div>
      </div>
    </div>

    <script>
      let currentUser = '';
      let scriptUrl = '';
      let leaderboardData = null;
      let currentStudio = 'ALL';

      // Auction Data
      let auctionItems = [];
      let allStudents = [];
      let selectedItem = null;
      let selectedStudent = null;

      window.onload = function() {
        google.script.run
          .withSuccessHandler(initDashboard)
          .withFailureHandler(showError)
          .getDataForDashboard();
      };

      function initDashboard(data) {
        document.getElementById('loading-screen').style.display = 'none';
        if (data.scriptUrl) scriptUrl = data.scriptUrl;

        if (!data.authorized) {
          document.getElementById('shrek-gate').style.display = 'flex';
          const emailDisplay = data.email ? data.email : "(Not Detected / Incognito)";
          document.getElementById('detected-email').textContent = emailDisplay;
          return;
        }

        currentUser = data.email;
        document.getElementById('user-email').textContent = 'Logged in as: ' + data.email;
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('main-nav').style.display = 'flex';

        const select = document.getElementById('class-select');
        data.courses.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name + (c.section ? ` (${c.section})` : '');
          select.appendChild(opt);
        });

        // Pre-fetch Leaderboard Data
        google.script.run.withSuccessHandler(data => {
          leaderboardData = data;
          renderLeaderboard();
        }).getLeaderboardData();

        // Pre-fetch Auction Data
        google.script.run.withSuccessHandler(data => {
          auctionItems = data.items;
          allStudents = data.students;

          // Populate Periods
          const pSelect = document.getElementById('auction-period');
          pSelect.innerHTML = ''; // Clear hardcoded

          if (data.periods && data.periods.length > 0) {
            data.periods.forEach(p => {
              const opt = document.createElement('option');
              opt.value = p;
              opt.textContent = "Period " + p; // Keep "Period X" format for UI
              pSelect.appendChild(opt);
            });
            // Select first by default
            pSelect.value = data.periods[0];
          } else {
             const opt = document.createElement('option');
             opt.textContent = "No Active Periods";
             pSelect.appendChild(opt);
          }

          renderAuctionItems();
        }).getAuctionData();
      }

      function switchView(view) {
        // HIDE ALL
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('leaderboard-view').style.display = 'none';
        document.getElementById('auction-view').style.display = 'none';
        document.getElementById('song-manager-view').style.display = 'none';
        document.getElementById('config-tab').style.display = 'none';
        document.getElementById('overlord-view').style.display = 'none';
        document.getElementById('curriculum-view').style.display = 'none';

        // RESET THEME
        const bg = document.getElementById('bg-layer');
        bg.classList.remove('theme-cyan', 'theme-gold', 'theme-purple', 'theme-pink', 'theme-green');

        // SHOW TARGET & SET THEME
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(b => b.classList.remove('active'));

        if (view === 'console') {
          document.getElementById('dashboard').style.display = 'block';
          bg.classList.add('theme-cyan');
          btns[0].classList.add('active');
        } else if (view === 'leaderboard') {
          document.getElementById('leaderboard-view').style.display = 'block';
          bg.classList.add('theme-gold');
          btns[1].classList.add('active');
        } else if (view === 'auction') {
          document.getElementById('auction-view').style.display = 'flex';
          bg.classList.add('theme-purple');
          btns[2].classList.add('active');
        } else if (view === 'song') {
          document.getElementById('song-manager-view').style.display = 'flex';
          bg.classList.add('theme-pink');
          btns[3].classList.add('active');
          loadSongManager(); // Auto load
        } else if (view === 'config') {
          document.getElementById('config-tab').style.display = 'block';
          bg.classList.add('theme-cyan'); // Reuse cyan or default
          btns[4].classList.add('active');
          onConfigTabShow();
        } else if (view === 'bonus') {
          document.getElementById('bonus-view').style.display = 'flex';
          bg.classList.add('theme-green');
          btns[5].classList.add('active');
        } else if (view === 'overlord') {
          document.getElementById('overlord-view').style.display = 'block';
          bg.classList.add('theme-cyan');
          btns[6].classList.add('active');
          loadOverlordData();
        } else if (view === 'curriculum') {
          document.getElementById('curriculum-view').style.display = 'block';
          bg.classList.add('theme-cyan');
          btns[7].classList.add('active');
          loadCurriculumData();
        }
      }

      function handleClassChange() {
        // When class changes, reload the active view if it depends on class
        if (document.getElementById('song-manager-view').style.display === 'flex') {
          loadSongManager();
        }
        // If bonus view is active, maybe warn user?
        // For now we assume they handle it manually via "Init Game"
      }

      function switchAccount() {
        if (!scriptUrl) scriptUrl = "https://script.google.com";
        const authUrl = "https://accounts.google.com/AccountChooser?continue=" + encodeURIComponent(scriptUrl);
        window.open(authUrl, "_top");
      }

      // === LEADERBOARD LOGIC ===
      function setStudio(studio, btn) {
        currentStudio = studio;
        document.querySelectorAll('.studio-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderLeaderboard();
      }

      function renderLeaderboard() {
        if (!leaderboardData) return;

        const period = document.getElementById('lb-period').value;
        const studio = currentStudio;

        const filter = (list) => {
          return list.filter(item => {
            const pMatch = period === 'ALL' || (item.period && item.period.toString() === period);
            const sMatch = studio === 'ALL' || item.studio === studio;
            return pMatch && sMatch;
          }).slice(0, 10);
        };

        renderList('lb-weekly', filter(leaderboardData.weekly));
        renderList('lb-alltime', filter(leaderboardData.allTime));
      }

      function renderList(elementId, data) {
        const ul = document.getElementById(elementId);
        ul.innerHTML = '';

        if (data.length === 0) {
          ul.innerHTML = '<li class="rpg-item" style="justify-content:center; color:gray;">No Data</li>';
          return;
        }

        data.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'rpg-item';
          li.style.animationDelay = (index * 0.1) + 's';

          li.innerHTML = `
            <div class="char-info">
              <span class="char-name">${index + 1}. ${item.name}</span>
              <span class="char-meta">Period ${item.period} | ${item.studio}</span>
            </div>
            <div class="char-score">${item.mp} MP</div>
          `;
          ul.appendChild(li);
        });
      }

      // === AUCTION LOGIC ===
      function renderAuctionItems() {
        const grid = document.getElementById('item-grid');
        grid.innerHTML = '';

        if(auctionItems.length === 0) {
          grid.innerHTML = '<div style="padding:20px; color:gray;">No items configued in sheet.</div>';
          return;
        }

        auctionItems.forEach(item => {
          const card = document.createElement('div');
          card.className = 'auction-card';
          // Use a default image if blank
          const imgUrl = item.image || 'https://via.placeholder.com/200x200/0f172a/22d3ee?text=No+Image';

          card.innerHTML = `
            <img src="${imgUrl}" class="card-img" alt="${item.name}">
            <div class="card-body">
              <div class="card-title">${item.name}</div>
              <div class="card-price">Min: ${item.minBid} TC</div>
            </div>
          `;

          card.onclick = () => selectAuctionItem(item, card);
          grid.appendChild(card);
        });
      }

      function selectAuctionItem(item, cardElement) {
        selectedItem = item;

        // Visual Selection
        document.querySelectorAll('.auction-card').forEach(c => c.classList.remove('selected'));
        cardElement.classList.add('selected');

        // Update Desk
        document.getElementById('selected-item-display').textContent = item.name;
        document.getElementById('bid-input').value = item.minBid;
        resetFeedback();
      }

      // Search Logic
      const searchInput = document.getElementById('student-search-input');
      const searchResults = document.getElementById('search-results');

      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const period = document.getElementById('auction-period').value;

        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }

        const matches = allStudents.filter(s => {
          // Strict period filter + fuzzy name match
          // Note: period from sheet might be "Period 1" or just "1"
          const sPeriod = s.period ? s.period.toString().replace(/\D/g,'') : '';
          return sPeriod === period && s.name.toLowerCase().includes(query);
        });

        renderSearchResults(matches);
      });

      function renderSearchResults(matches) {
        searchResults.innerHTML = '';
        if (matches.length === 0) {
          searchResults.style.display = 'none';
          return;
        }

        matches.forEach(s => {
          const div = document.createElement('div');
          div.className = 'search-item';
          div.innerHTML = `<strong>${s.name}</strong><span>${s.email}</span>`;
          div.onclick = () => selectStudent(s);
          searchResults.appendChild(div);
        });

        searchResults.style.display = 'block';
      }

      function selectStudent(s) {
        selectedStudent = s;
        searchInput.value = s.name;
        document.getElementById('selected-student-email').value = s.email;
        searchResults.style.display = 'none';
        resetFeedback();
      }

      // Hide results when clicking away
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });

      function resetFeedback() {
        const box = document.getElementById('feedback-display');
        box.className = 'feedback-box';
        box.textContent = "READY TO CHECK";
        document.getElementById('btn-finalize').disabled = true;
      }

      function checkBid() {
        if (!selectedStudent || !selectedItem) { alert("Select student and item first."); return; }
        const bid = document.getElementById('bid-input').value;
        if (!bid || bid <= 0) { alert("Enter valid bid."); return; }

        const box = document.getElementById('feedback-display');
        box.textContent = "Checking...";
        box.className = 'feedback-box';

        google.script.run.withSuccessHandler(res => {
          if (res.approved) {
            box.textContent = `‚úÖ BID ACCEPTED\nBalance: ${res.balance}`;
            box.className = 'feedback-box feedback-success';
            document.getElementById('btn-finalize').disabled = false;
          } else {
            box.textContent = `‚ùå DENIED\nBalance: ${res.balance}`;
            box.className = 'feedback-box feedback-error';
            document.getElementById('btn-finalize').disabled = true;
          }
        }).checkStudentBalance(selectedStudent.email, bid);
      }

      function finalizeBid() {
        const bid = document.getElementById('bid-input').value;
        const btn = document.getElementById('btn-finalize');
        btn.disabled = true;
        btn.textContent = "PROCESSING...";

        google.script.run.withSuccessHandler(res => {
          const box = document.getElementById('feedback-display');
          btn.textContent = "SOLD!";

          if (res.success) {
            box.textContent = `üéâ SOLD!\nNew Balance: ${res.newBalance}`;
            // Reset for next
            setTimeout(() => {
               searchInput.value = '';
               selectedStudent = null;
               document.getElementById('selected-student-email').value = '';
               btn.disabled = true;
               resetFeedback();
            }, 3000);
          } else {
            alert("Error: " + res.message);
            resetFeedback();
          }
        }).finalizeAuctionTransaction(selectedStudent.email, selectedItem.name, bid);
      }


      // === GRADING LOGIC ===
      function runOrganizer() {
        const courseId = document.getElementById('class-select').value;
        if (!courseId) { alert("Please select a class first."); return; }
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "‚è≥ SCANNING...";
        btn.disabled = true;
        document.getElementById('org-result').innerHTML = '';

        google.script.run.withSuccessHandler(function(res) {
            btn.textContent = originalText; btn.disabled = false;
            if (res.success) {
              const msg = res.count > 0 ? `Organized ${res.count} items.` : "No pending files found.";
              document.getElementById('org-result').innerHTML = `‚úÖ Done! ${msg} <a href="${res.url}" target="_blank">Open Folder ‚Üó</a>`;
            } else { alert("Error: " + res.error); }
          }).organizeDriveFiles(courseId);
      }

      function openGrader() {
        const courseId = document.getElementById('class-select').value;
        if (!courseId) { alert("Please select a class first."); return; }
        document.getElementById('grader-modal').style.display = 'flex';
        document.getElementById('grader-cards').innerHTML = '';
        document.getElementById('grader-loading').style.display = 'block';
        document.getElementById('grader-empty').style.display = 'none';
        google.script.run.withSuccessHandler(renderGrader).getGradingData(courseId);
      }

      function closeGrader() { document.getElementById('grader-modal').style.display = 'none'; }

      function renderGrader(list) {
        document.getElementById('grader-loading').style.display = 'none';

        // Safety Check
        if (!list || !Array.isArray(list)) {
          alert("System Error: Invalid data received from server.\n" + JSON.stringify(list));
          return;
        }

        const container = document.getElementById('grader-cards');
        if (list.length === 0) { document.getElementById('grader-empty').style.display = 'block'; return; }

        try {
          list.forEach(item => {
            // Create card
            const card = document.createElement('div');
            card.className = 'grader-card';
            card.id = 'card-' + item.submissionId;

            // Build files HTML
            let filesHtml = '';
            if (item.files && item.files.length > 0) {
              item.files.forEach(f => {
                filesHtml += `<a href="${f.url}" target="_blank" class="card-file-link">üìÑ ${f.title}</a>`;
              });
            } else {
              filesHtml = '<span style="color:#666; font-style:italic; font-size:12px;">No files submitted</span>';
            }

            // Build card HTML
            card.innerHTML = `
              <div class="card-header">
                <div class="card-assignment-title">${item.assignmentTitle}</div>
                <div class="card-student-name">${item.studentName}</div>
              </div>
              <div class="card-body">
                <div class="card-section">
                  <div class="card-label">üìé Submitted Files</div>
                  <div class="card-files">${filesHtml}</div>
                </div>
                <div class="card-section">
                  <div class="card-label">üí¨ Feedback</div>
                  <textarea id="comment-${item.submissionId}" class="card-feedback-textarea" placeholder="Enter feedback for student..."></textarea>
                </div>
                <div class="card-section">
                  <div class="card-label">‚≠ê Grade</div>
                  <div class="card-grade-row">
                    <input type="number" class="card-grade-input" id="grade-${item.submissionId}" value="${item.currentGrade || ''}" placeholder="0">
                    <span class="card-max-points">/ ${item.maxPoints} MP</span>
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <button class="card-grade-btn" onclick="submitGrade('${item.userId}', '${item.assignmentId}', '${item.submissionId}')">
                  üöÄ Grade & Return
                </button>
                <div class="card-progress-bar" id="progress-${item.submissionId}"></div>
              </div>
            `;

            container.appendChild(card);
          });
        } catch (e) {
          alert("Rendering Error: " + e.message);
          console.error(e);
        }
      }

      function submitGrade(userId, assignId, subId) {
        const gradeVal = document.getElementById('grade-' + subId).value;
        const commentVal = document.getElementById('comment-' + subId).value;

        if (gradeVal === '') {
          alert("‚ö†Ô∏è Please enter a grade first.");
          return;
        }

        // Get card elements
        const card = document.getElementById('card-' + subId);
        const btn = card.querySelector('.card-grade-btn');
        const progressBar = document.getElementById('progress-' + subId);

        // Disable button and show loading state
        btn.disabled = true;
        btn.classList.add('loading');
        btn.innerHTML = '‚è≥ Grading';

        // Start progress bar animation
        progressBar.classList.add('active');

        // Animate progress bar through stages
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 8;
          if (progress <= 90) {
            progressBar.style.width = progress + '%';
          }
        }, 150);

        // Call backend
        google.script.run.withSuccessHandler(function(res) {
          clearInterval(progressInterval);

          if (res.success) {
            // Complete the progress bar
            progressBar.style.width = '100%';

            setTimeout(() => {
              progressBar.classList.remove('active');
              btn.classList.remove('loading');
              btn.innerHTML = '‚úÖ Returned';
              btn.style.background = 'var(--success)';
              card.classList.add('card-success');

              // Optional: Fade out and remove card after delay
              setTimeout(() => {
                card.style.transition = 'opacity 0.5s, transform 0.5s';
                card.style.opacity = '0.5';
                card.style.transform = 'scale(0.95)';
              }, 1500);
            }, 300);
          } else {
            // Handle error
            progressBar.style.width = '0%';
            progressBar.classList.remove('active');
            btn.classList.remove('loading');
            btn.innerHTML = '‚ùå Retry';
            btn.disabled = false;
            btn.style.background = 'var(--danger)';

            alert("‚ùå Error: " + res.error);
          }
        }).withFailureHandler(function(err) {
          clearInterval(progressInterval);
          progressBar.style.width = '0%';
          progressBar.classList.remove('active');
          btn.classList.remove('loading');
          btn.innerHTML = '‚ùå Retry';
          btn.disabled = false;
          btn.style.background = 'var(--danger)';
          alert("‚ùå Failed: " + err.message);
        }).gradeAndReturnSubmission(document.getElementById('class-select').value, assignId, userId, gradeVal, subId, commentVal);
      }

      function showError(err) { alert("System Error: " + err.message); }

      // === SONG MANAGER LOGIC ===
      function loadSongManager() {
        const courseId = document.getElementById('class-select').value;
        const inbox = document.getElementById('song-inbox');
        const playlist = document.getElementById('song-playlist');

        if (!courseId) {
          inbox.innerHTML = '<div style="padding:20px; color:gray;">Please select a class from the top menu.</div>';
          playlist.innerHTML = '<div style="padding:20px; color:gray;">No class selected.</div>';
          return;
        }

        inbox.innerHTML = '<div style="padding:20px;">Loading...</div>';

        google.script.run.withSuccessHandler(renderSongLists).getSongManagerData(courseId);
      }

      function renderSongLists(data) {
        const inbox = document.getElementById('song-inbox');
        const playlist = document.getElementById('song-playlist');
        const label = document.getElementById('playlist-period-label');

        inbox.innerHTML = '';
        playlist.innerHTML = '';
        label.textContent = data.period ? `Period ${data.period}` : 'Unknown Period';

        const pending = data.requests.filter(r => r.status === 'PENDING');
        const staged = data.requests.filter(r => r.status === 'STAGED');

        // Render Inbox
        if (pending.length === 0) {
          inbox.innerHTML = '<div style="padding:20px; color:gray;">No pending requests.</div>';
        } else {
          pending.forEach(r => {
            const div = document.createElement('div');
            div.className = 'song-card';

            // XSS Prevention: Use textContent where possible or careful construction
            const infoDiv = document.createElement('div');

            const mainInfo = document.createElement('div');
            mainInfo.className = 'song-info';
            const strong = document.createElement('strong');
            strong.textContent = r.artist;
            mainInfo.appendChild(strong);
            mainInfo.appendChild(document.createTextNode(' - ' + r.song));

            const metaInfo = document.createElement('div');
            metaInfo.className = 'song-meta';
            metaInfo.textContent = r.studentName + ' ';

            if (r.link) {
              const link = document.createElement('a');
              link.href = r.link;
              link.target = '_blank';
              link.textContent = 'üîó';
              link.style.color = '#34d399'; // Green link
              link.style.textDecoration = 'none';
              link.title = 'Preview Link';
              metaInfo.appendChild(link);
            }

            // EDIT BUTTON
            const editBtn = document.createElement('button');
            editBtn.textContent = '‚úé';
            editBtn.style.background = 'none';
            editBtn.style.border = 'none';
            editBtn.style.color = 'var(--muted)';
            editBtn.style.cursor = 'pointer';
            editBtn.style.marginLeft = '10px';
            editBtn.onclick = () => editSongRequest(r);
            metaInfo.appendChild(editBtn);

            infoDiv.appendChild(mainInfo);
            infoDiv.appendChild(metaInfo);

            const btn = document.createElement('button');
            btn.className = 'btn-stage';
            btn.textContent = '‚ûï ADD';
            btn.onclick = () => stageSong(r.rowIndex, 'STAGED');

            div.appendChild(infoDiv);
            div.appendChild(btn);
            inbox.appendChild(div);
          });
        }

        // Render Playlist
        if (staged.length === 0) {
          playlist.innerHTML = '<div style="padding:20px; color:gray;">No songs staged.</div>';
          document.getElementById('btn-finalize-playlist').disabled = true;
        } else {
          staged.forEach(r => {
            const div = document.createElement('div');
            div.className = 'song-card staged';

            const infoDiv = document.createElement('div');
            const mainInfo = document.createElement('div');
            mainInfo.className = 'song-info';
            const strong = document.createElement('strong');
            strong.textContent = r.artist;
            mainInfo.appendChild(strong);
            mainInfo.appendChild(document.createTextNode(' - ' + r.song));

            const metaInfo = document.createElement('div');
            metaInfo.className = 'song-meta';
            metaInfo.textContent = r.studentName;

            if (r.link) {
              const link = document.createElement('a');
              link.href = r.link;
              link.target = '_blank';
              link.textContent = ' üîó';
              link.style.color = '#34d399';
              link.style.textDecoration = 'none';
              metaInfo.appendChild(link);
            }

            infoDiv.appendChild(mainInfo);
            infoDiv.appendChild(metaInfo);

            const btn = document.createElement('button');
            btn.className = 'btn-remove';
            btn.textContent = '‚ùå REMOVE';
            btn.onclick = () => stageSong(r.rowIndex, 'PENDING');

            div.appendChild(infoDiv);
            div.appendChild(btn);
            playlist.appendChild(div);
          });
          document.getElementById('btn-finalize-playlist').disabled = false;
        }
      }

      function stageSong(rowIndex, status) {
        // Optimistic Update (Sort of, we just reload for simplicity)
        google.script.run.withSuccessHandler(() => {
          loadSongManager(); // Reload to refresh lists
        }).toggleSongStaging(rowIndex, status);
      }

      function editSongRequest(r) {
        const newArtist = prompt("Edit Artist:", r.artist);
        if (newArtist === null) return;

        const newSong = prompt("Edit Song:", r.song);
        if (newSong === null) return;

        const newLink = prompt("Edit YouTube Link (optional):", r.link);
        if (newLink === null) return;

        google.script.run.withSuccessHandler(() => {
          loadSongManager();
        }).updateSongRequest(r.rowIndex, newArtist, newSong, newLink);
      }

      function finalizePlaylist() {
        const courseId = document.getElementById('class-select').value;
        const btn = document.getElementById('btn-finalize-playlist');
        const resultDiv = document.getElementById('playlist-result');

        btn.disabled = true;
        btn.textContent = "CREATING...";
        resultDiv.textContent = "";

        google.script.run.withSuccessHandler(res => {
           if (res.success) {
             btn.textContent = "‚úÖ DONE!";
             resultDiv.innerHTML = `<a href="${res.playlistUrl}" target="_blank">OPEN PLAYLIST ‚Üó</a><br>${res.message}`;
             setTimeout(loadSongManager, 2000); // Reload to clear staged items
           } else {
             btn.textContent = "‚ùå ERROR";
             resultDiv.textContent = res.message;
             setTimeout(() => { btn.textContent = "üöÄ FINALIZE PLAYLIST"; btn.disabled = false; }, 3000);
           }
        }).finalizePlaylist(courseId);
      }
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CONFIG TAB FUNCTIONS - BATCH VERSION
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      var registryStudents = [];
      var pendingOverrides = {}; // { userId: { email, classroomName, rosterName, action } }
      var unmatchedStudentsCache = [];

      function loadUnmatchedStudents() {
        var container = document.getElementById('unmatched-list');
        container.innerHTML = '<p style="color: var(--muted);">Loading...</p>';
        pendingOverrides = {};
        updateFinalizeButton();

        // Load registry students first if needed
        var loadStudents = registryStudents.length > 0
          ? Promise.resolve(registryStudents)
          : new Promise(function(resolve) {
              google.script.run
                .withSuccessHandler(function(students) {
                  registryStudents = students;
                  resolve(students);
                })
                .getRegistryStudentsForDropdown();
            });

        loadStudents.then(function() {
          google.script.run
            .withSuccessHandler(function(students) {
              unmatchedStudentsCache = students;
              renderUnmatchedList(students);
            })
            .withFailureHandler(function(err) {
              container.innerHTML = '<p style="color: var(--danger);">Error: ' + err.message + '</p>';
            })
            .getUnmatchedStudents();
        });
      }

      function renderUnmatchedList(students) {
        var container = document.getElementById('unmatched-list');

        if (!students || students.length === 0) {
          container.innerHTML = '<p style="color: var(--success);">‚úÖ All students matched!</p>';
          return;
        }

        var html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<tr style="background: var(--bg-header); position: sticky; top: 0;">';
        html += '<th style="padding: 10px; text-align: left; color: var(--primary);">Classroom Name</th>';
        html += '<th style="padding: 10px; width: 60px; color: var(--primary);">Period</th>';
        html += '<th style="padding: 10px; text-align: left; color: var(--primary);">Link To</th>';
        html += '<th style="padding: 10px; width: 80px; color: var(--primary);">Action</th>';
        html += '</tr>';

        students.forEach(function(s) {
          var pending = pendingOverrides[s.userId];
          var rowStyle = pending ? 'background: rgba(251, 191, 36, 0.2);' : ''; // Amber-ish highlight

          html += '<tr style="border-bottom: 1px solid var(--border); ' + rowStyle + '" id="row-' + s.userId + '">';
          html += '<td style="padding: 10px; color: white;">' + escapeHtml(s.classroomName) + '</td>';
          html += '<td style="padding: 10px; text-align: center; color: var(--muted);">' + s.period + '</td>';
          html += '<td style="padding: 10px;">';
          html += '<select onchange="onStudentSelect(\'' + s.userId + '\', \'' + escapeJs(s.classroomName) + '\', this.value)" ';
          html += 'style="width: 100%; padding: 6px; background: var(--bg-deep); border: 1px solid var(--border); color: white; border-radius: 4px;" ';
          html += 'id="select-' + s.userId + '">';
          html += '<option value="">-- Select --</option>';
          html += '<option value="IGNORE">üö´ Ignore (dropped)</option>';

          registryStudents.forEach(function(rs) {
            var selected = (pending && pending.email === rs.email) ? 'selected' : '';
            html += '<option value="' + rs.email + '" ' + selected + '>' + escapeHtml(rs.name) + '</option>';
          });

          html += '</select>';
          html += '</td>';
          html += '<td style="padding: 10px; text-align: center;">';
          if (pending) {
            html += '<button onclick="clearPending(\'' + s.userId + '\')" class="btn-secondary" style="padding: 2px 8px; font-size: 12px;">‚Ü©Ô∏è</button>';
          }
          html += '</td>';
          html += '</tr>';
        });

        html += '</table>';
        container.innerHTML = html;
      }

      function escapeJs(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
      }

      function onStudentSelect(userId, classroomName, value) {
        if (!value) {
          delete pendingOverrides[userId];
        } else if (value === 'IGNORE') {
          pendingOverrides[userId] = {
            userId: userId,
            email: 'IGNORED',
            classroomName: classroomName,
            rosterName: '',
            note: 'Dropped/Does not exist'
          };
        } else {
          var rosterStudent = registryStudents.find(function(s) { return s.email === value; });
          pendingOverrides[userId] = {
            userId: userId,
            email: value,
            classroomName: classroomName,
            rosterName: rosterStudent ? rosterStudent.name : '',
            note: ''
          };
        }

        // Update row highlight
        var row = document.getElementById('row-' + userId);
        if (row) {
          row.style.background = pendingOverrides[userId] ? 'rgba(251, 191, 36, 0.2)' : '';
        }

        updateFinalizeButton();
      }

      function clearPending(userId) {
        delete pendingOverrides[userId];
        var select = document.getElementById('select-' + userId);
        if (select) select.value = '';
        var row = document.getElementById('row-' + userId);
        if (row) row.style.background = '';
        updateFinalizeButton();
      }

      function updateFinalizeButton() {
        var count = Object.keys(pendingOverrides).length;
        var btn = document.getElementById('finalize-btn');
        var countSpan = document.getElementById('pending-count');

        if (count > 0) {
          btn.style.display = 'inline-block';
          countSpan.textContent = count;
        } else {
          btn.style.display = 'none';
        }
      }

      function finalizeAllOverrides() {
        var overridesList = Object.values(pendingOverrides);

        if (overridesList.length === 0) {
          alert('No changes to save.');
          return;
        }

        if (!confirm('Save ' + overridesList.length + ' override(s)?')) {
          return;
        }

        var btn = document.getElementById('finalize-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Saving...';

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            pendingOverrides = {};
            updateFinalizeButton();
            loadUnmatchedStudents();
            loadCurrentOverrides();
            try { showToast('‚úÖ Saved ' + result.saved + ' override(s)!'); } catch(e) { alert('‚úÖ Saved ' + result.saved + ' override(s)!'); }

            if (result.errors && result.errors.length > 0) {
              alert('Some errors occurred:\n' + result.errors.join('\n'));
            }
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            btn.innerHTML = 'üíæ Finalize All (<span id="pending-count">' + overridesList.length + '</span>)';
            alert('Error: ' + err.message);
          })
          .saveStudentOverridesBatch(overridesList);
      }

      function loadCurrentOverrides() {
        var container = document.getElementById('overrides-list');

        google.script.run
          .withSuccessHandler(function(overrides) {
            if (!overrides || overrides.length === 0) {
              container.innerHTML = '<p style="color: var(--muted); font-style: italic;">No manual overrides set.</p>';
              return;
            }

            var html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: var(--bg-header);"><th style="padding: 8px; text-align: left; color: var(--primary);">Classroom Name</th><th style="padding: 8px; text-align: left; color: var(--primary);">Linked To</th><th style="padding: 8px; width: 60px; color: var(--primary);">Action</th></tr>';

            overrides.forEach(function(o) {
              var linkedTo = o.email === 'IGNORED' ? '<span style="color: var(--warning);">üö´ Ignored</span>' : escapeHtml(o.rosterName || o.email);
              html += '<tr style="border-bottom: 1px solid var(--border);">';
              html += '<td style="padding: 8px; color: white;">' + escapeHtml(o.classroomName) + '</td>';
              html += '<td style="padding: 8px; color: var(--muted);">' + linkedTo + '</td>';
              html += '<td style="padding: 8px; text-align: center;">';
              html += '<button onclick="deleteOverride(\'' + o.userId + '\')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px; border-color: var(--danger); color: var(--danger);">üóëÔ∏è</button>';
              html += '</td></tr>';
            });

            html += '</table>';
            container.innerHTML = html;
          })
          .withFailureHandler(function(err) {
            container.innerHTML = '<p style="color: var(--danger);">Error: ' + err.message + '</p>';
          })
          .getCurrentOverrides();
      }

      function deleteOverride(userId) {
        if (!confirm('Remove this override?')) return;

        google.script.run
          .withSuccessHandler(function(result) {
            loadCurrentOverrides();
            loadUnmatchedStudents();
            try { showToast('üóëÔ∏è Override removed'); } catch(e) { alert('üóëÔ∏è Override removed'); }
          })
          .withFailureHandler(function(err) {
            alert('Error: ' + err.message);
          })
          .deleteStudentOverride(userId);
      }

      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function onConfigTabShow() {
        loadCurrentOverrides();
      }

      // === BONUS ROUND LOGIC ===
      let activeGameId = null;
      let gameTicker = null;

      function initBonusGame() {
        const courseId = document.getElementById('class-select').value;
        if (!courseId) { alert("Select a class first."); return; }

        if (!confirm("Start new Bonus Round session? This will reset any active game for this class.")) return;

        google.script.run.withSuccessHandler(res => {
          if (res.success) {
            activeGameId = res.gameId;
            updateBonusStatus("GAME INITIALIZED. READY TO POST LINK.", "white");
            document.getElementById('btn-bonus-link').disabled = false;
            document.getElementById('btn-bonus-start').disabled = false;

            // Initial HUD Update
            document.getElementById('bonus-hp-text').textContent = `${res.energy} / ${res.energy}`;
            document.getElementById('bonus-hp-fill').style.width = '100%';
            document.getElementById('bonus-question-text').textContent = "WAITING FOR PLAYERS...";
          } else {
            alert("Error: " + res.error);
          }
        }).initGame(courseId);
      }

      function postBonusLink() {
        if (!activeGameId) return;
        const courseId = document.getElementById('class-select').value;
        const btn = document.getElementById('btn-bonus-link');
        btn.textContent = "POSTING..."; btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
          btn.textContent = "üîó POST LINK";
          if (res.success) {
            updateBonusStatus("LINK POSTED! WAIT FOR STUDENTS TO JOIN.", "#34d399");
          } else {
            alert("Error: " + res.message);
            btn.disabled = false;
          }
        }).postGameLink(courseId, activeGameId);
      }

      function startBonusRound() {
        if (!activeGameId) return;

        google.script.run.withSuccessHandler(res => {
          if (res.success) {
            document.getElementById('btn-bonus-start').disabled = true;
            document.getElementById('btn-bonus-next').disabled = false;
            startGameLoop();
          }
        }).setGameActive(activeGameId);
      }

      function startGameLoop() {
        if (gameTicker) clearInterval(gameTicker);
        gameTicker = setInterval(() => {
          google.script.run.withSuccessHandler(updateBonusHUD).tickGameLoop(activeGameId);
        }, 5000); // 5 seconds tick
      }

      function updateBonusHUD(state) {
        if (!state || state.error) return;

        // Energy
        const pct = (state.currentEnergy / state.maxEnergy) * 100;
        document.getElementById('bonus-hp-fill').style.width = pct + "%";
        document.getElementById('bonus-hp-text').textContent = `${state.currentEnergy} / ${state.maxEnergy}`;

        if (pct < 30) document.getElementById('bonus-hp-fill').style.background = "#ef4444"; // Red
        else document.getElementById('bonus-hp-fill').style.background = "linear-gradient(90deg, #34d399, #10b981)";

        // Stats
        document.getElementById('bonus-streak').textContent = state.streak;
        document.getElementById('bonus-round').textContent = `${state.currentRound + 1}`;

        // Question
        if (state.questions && state.questions[state.currentRound]) {
          document.getElementById('bonus-question-text').textContent = state.questions[state.currentRound].text;
        }

        // Status
        if (state.status === 'GAME_OVER') {
          updateBonusStatus("GAME OVER - MISSION FAILED", "#ef4444");
          stopBonusGameUI();
        } else if (state.status === 'VICTORY') {
          updateBonusStatus("VICTORY! ALL ROUNDS CLEARED", "#fbbf24");
          stopBonusGameUI();
        } else {
          updateBonusStatus("LIVE - ROUND IN PROGRESS", "#34d399");

          // Trigger FX if damage taken
          if (state.lastTickDamage > 0) {
             triggerBonusShake();
             createParticles(state.lastTickDamage, 'damage');
          }
          if (state.lastTickCorrect > 0) {
             createParticles(state.lastTickCorrect, 'spark');
          }
        }
      }

      function nextBonusQuestion() {
        if (!activeGameId) return;
        const btn = document.getElementById('btn-bonus-next');
        btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
          btn.disabled = false;
          if (res.status === 'VICTORY') {
            updateBonusStatus("VICTORY!", "gold");
            stopBonusGameUI();
          }
        }).advanceRound(activeGameId);
      }

      function stopBonusGame() {
        if (!activeGameId) return;
        if (!confirm("End game?")) return;

        google.script.run.stopGame(activeGameId);
        stopBonusGameUI();
        updateBonusStatus("GAME ENDED", "white");
      }

      function stopBonusGameUI() {
        if (gameTicker) clearInterval(gameTicker);
        document.getElementById('btn-bonus-start').disabled = true;
        document.getElementById('btn-bonus-next').disabled = true;
        document.getElementById('btn-bonus-link').disabled = true;
        activeGameId = null;
      }

      function updateBonusStatus(msg, color) {
        const el = document.getElementById('bonus-status-msg');
        el.textContent = msg;
        el.style.color = color;
      }

      function triggerBonusShake() {
        const board = document.getElementById('bonus-board');
        board.style.transform = "translate(5px, 0)";
        setTimeout(() => board.style.transform = "translate(-5px, 0)", 50);
        setTimeout(() => board.style.transform = "translate(5px, 0)", 100);
        setTimeout(() => board.style.transform = "translate(0, 0)", 150);
      }

      // === PARTICLE ENGINE ===
      const canvas = document.getElementById('particle-canvas');
      const ctx = canvas.getContext('2d');
      let particles = [];

      function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
      }
      window.addEventListener('resize', resizeCanvas);
      // Call once on init (or when view switches) to ensure size

      class Particle {
        constructor(type) {
          this.x = canvas.width / 2;
          this.y = canvas.height / 2;
          this.type = type;

          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 5 + 2;

          this.vx = Math.cos(angle) * speed;
          this.vy = Math.sin(angle) * speed;

          this.life = 100;
          this.size = Math.random() * 5 + 2;

          if (type === 'damage') {
            this.color = `rgba(239, 68, 68, ${Math.random()})`; // Red
            this.vy -= 2; // Smoke rises slightly
          } else {
            this.color = `rgba(251, 191, 36, ${Math.random()})`; // Gold/Spark
          }
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.life -= 2;

          if (this.type === 'spark') this.vy += 0.1; // Gravity
        }

        draw() {
          ctx.globalAlpha = this.life / 100;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
          ctx.globalAlpha = 1;
        }
      }

      function createParticles(count, type) {
        resizeCanvas(); // Ensure size is correct before spawning
        for (let i = 0; i < count; i++) {
          particles.push(new Particle(type));
        }
        if (particles.length > 0 && !isAnimating) {
          animateParticles();
        }
      }

      let isAnimating = false;
      function animateParticles() {
        isAnimating = true;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let i = 0; i < particles.length; i++) {
          particles[i].update();
          particles[i].draw();

          if (particles[i].life <= 0) {
            particles.splice(i, 1);
            i--;
          }
        }

        if (particles.length > 0) {
          requestAnimationFrame(animateParticles);
        } else {
          isAnimating = false;
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // OVERLORD DASHBOARD FUNCTIONS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      let overlordData = null;
      let selectedManageStudent = null;

      function switchOverlordTab(tab) {
        document.getElementById('overlord-skeys').style.display = 'none';
        document.getElementById('overlord-test').style.display = 'none';
        document.getElementById('overlord-manage').style.display = 'none';

        document.querySelectorAll('.overlord-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('overlord-' + tab).style.display = 'block';
      }

      function loadOverlordData() {
        google.script.run
          .withSuccessHandler(data => {
            overlordData = data;
            renderOverlordData();
          })
          .withFailureHandler(err => {
            console.error('Failed to load Overlord data:', err);
          })
          .getOverlordDashboardData();
      }

      function renderOverlordData() {
        if (!overlordData) return;

        // SafeSearch status
        document.getElementById('safesearch-status').textContent = overlordData.safeSearch ? 'ON' : 'OFF';
        document.getElementById('safesearch-status').style.color = overlordData.safeSearch ? 'var(--success)' : 'var(--danger)';

        // Deployment status
        const statusDiv = document.getElementById('deployment-status');
        const periods = overlordData.deploymentStatus;
        if (Object.keys(periods).length === 0) {
          statusDiv.innerHTML = '<p style="color: var(--muted);">No skeys deployed yet.</p>';
        } else {
          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">';
          for (const [period, info] of Object.entries(periods)) {
            html += `<div style="background: rgba(34, 211, 238, 0.1); border: 1px solid var(--primary); padding: 10px; border-radius: 4px; text-align: center;">
              <div style="color: var(--primary); font-weight: bold;">Period ${period}</div>
              <div style="font-size: 24px; color: white; font-family: 'Consolas', monospace;">${info.count}</div>
              <div style="font-size: 11px; color: var(--muted);">students</div>
            </div>`;
          }
          html += '</div>';
          statusDiv.innerHTML = html;
        }

        // Test students
        renderTestStudents();
      }

      function renderTestStudents() {
        const list = document.getElementById('test-students-list');
        const students = overlordData.testStudents || [];

        if (students.length === 0) {
          list.innerHTML = '<p style="color: var(--muted); font-style: italic;">No test students created yet.</p>';
          return;
        }

        let html = '';
        students.forEach(s => {
          html += `<div class="test-student-card">
            <div class="test-student-info">
              <div class="test-student-name">${s.name}</div>
              <div class="test-student-meta">
                ${s.email} | Token: <span style="color: var(--primary);">${s.token}</span> | ${s.period}
              </div>
              ${s.notes ? '<div class="test-student-meta" style="font-style: italic;">' + s.notes + '</div>' : ''}
            </div>
            <div class="test-student-actions">
              <button class="btn-secondary" onclick="deployTestSkey('${s.email}')" style="font-size: 11px;">üì• Deploy Skey</button>
              <button class="btn-secondary" onclick="deleteTestStudent('${s.email}')" style="font-size: 11px; border-color: var(--danger); color: var(--danger);">üóëÔ∏è</button>
            </div>
          </div>`;
        });

        list.innerHTML = html;
      }

      function deploySkeysPeriod() {
        const period = document.getElementById('overlord-period-select').value;
        if (!period) {
          document.getElementById('skey-result').innerHTML = '<span style="color: var(--danger);">Please select a period.</span>';
          return;
        }

        document.getElementById('skey-result').innerHTML = '<span style="color: var(--primary);">Deploying...</span>';

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              document.getElementById('skey-result').innerHTML = `
                <span style="color: var(--success);">‚úÖ Deployed ${result.deployed} skeys!</span>
                ${result.failed > 0 ? '<span style="color: var(--danger);"> (${result.failed} failed)</span>' : ''}
                <br><a href="${result.folderUrl}" target="_blank">üìÇ Open Folder</a>
              `;
              loadOverlordData(); // Refresh status
            } else {
              document.getElementById('skey-result').innerHTML = `<span style="color: var(--danger);">‚ùå ${result.error}</span>`;
            }
          })
          .withFailureHandler(err => {
            document.getElementById('skey-result').innerHTML = `<span style="color: var(--danger);">‚ùå Error: ${err.message}</span>`;
          })
          .deploySkeysPeriodFromDashboard(period);
      }

      function toggleSafeSearch() {
        google.script.run
          .withSuccessHandler(result => {
            overlordData.safeSearch = result.safeSearch;
            document.getElementById('safesearch-status').textContent = result.safeSearch ? 'ON' : 'OFF';
            document.getElementById('safesearch-status').style.color = result.safeSearch ? 'var(--success)' : 'var(--danger)';
          })
          .toggleSafeSearch();
      }

      function createTestStudent() {
        const name = document.getElementById('test-name').value.trim();
        const email = document.getElementById('test-email').value.trim();
        const period = document.getElementById('test-period').value;
        const notes = document.getElementById('test-notes').value.trim();

        if (!name || !email) {
          document.getElementById('test-create-result').innerHTML = '<span style="color: var(--danger);">Name and email are required.</span>';
          return;
        }

        document.getElementById('test-create-result').innerHTML = '<span style="color: var(--primary);">Creating...</span>';

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              document.getElementById('test-create-result').innerHTML = `
                <span style="color: var(--success);">‚úÖ Created! Token: <strong>${result.token}</strong></span>
              `;
              // Clear form
              document.getElementById('test-name').value = '';
              document.getElementById('test-email').value = '';
              document.getElementById('test-notes').value = '';
              // Refresh
              loadOverlordData();
            } else {
              document.getElementById('test-create-result').innerHTML = `<span style="color: var(--danger);">‚ùå ${result.error}</span>`;
            }
          })
          .withFailureHandler(err => {
            document.getElementById('test-create-result').innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
          })
          .createTestStudentFromDashboard(name, email, period, notes);
      }

      function deleteTestStudent(email) {
        if (!confirm('Delete test student ' + email + '?')) return;

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              loadOverlordData();
            } else {
              alert('Error: ' + result.error);
            }
          })
          .deleteTestStudentFromDashboard(email);
      }

      function deployTestSkey(email) {
        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              alert('Skey deployed!\\n\\nToken: ' + result.token + '\\nFile: ' + result.fileUrl);
            } else {
              alert('Error: ' + result.error);
            }
          })
          .deployTestStudentSkeyFromDashboard(email);
      }

      // === MANAGE STUDENTS ===

      let manageSearchTimeout = null;

      function searchStudentsManage() {
        const query = document.getElementById('manage-search').value.trim();
        const resultsDiv = document.getElementById('manage-search-results');

        if (query.length < 2) {
          resultsDiv.style.display = 'none';
          return;
        }

        clearTimeout(manageSearchTimeout);
        manageSearchTimeout = setTimeout(() => {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success && result.students.length > 0) {
                let html = '';
                result.students.forEach(s => {
                  const isTest = s.isTest ? '<span style="color: var(--warning);">[TEST]</span>' : '';
                  html += `<div class="manage-search-item" onclick="selectManageStudent('${s.token}')">
                    <strong>${s.token} ${isTest}</strong>
                    <span>${s.email || s.studentId} | Period ${s.period} | ${s.balance} TC</span>
                  </div>`;
                });
                resultsDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
              } else {
                resultsDiv.innerHTML = '<div style="padding: 15px; color: var(--muted);">No students found.</div>';
                resultsDiv.style.display = 'block';
              }
            })
            .searchStudentsFromDashboard(query);
        }, 300);
      }

      function selectManageStudent(token) {
        document.getElementById('manage-search-results').style.display = 'none';
        document.getElementById('manage-search').value = token;

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              selectedManageStudent = result;
              renderManageStudentPanel();
            } else {
              alert('Error loading student: ' + result.error);
            }
          })
          .getStudentDetailsFromDashboard(token);
      }

      function renderManageStudentPanel() {
        const panel = document.getElementById('manage-student-panel');
        const s = selectedManageStudent;

        document.getElementById('manage-student-token').textContent = s.token;
        document.getElementById('manage-student-period').textContent = s.period || '?';
        document.getElementById('manage-student-balance').textContent = s.balance;

        const testBadge = document.getElementById('manage-test-badge');
        testBadge.style.display = s.isTest ? 'inline' : 'none';

        // Inventory
        const invDiv = document.getElementById('manage-inventory-list');
        const inv = s.inventory || {};
        const items = Object.entries(inv);

        if (items.length === 0) {
          invDiv.innerHTML = '<p style="color: var(--muted); font-style: italic;">No items</p>';
        } else {
          let html = '';
          items.forEach(([item, count]) => {
            html += `<span class="inv-tag">${item}: ${count}</span>`;
          });
          invDiv.innerHTML = html;
        }

        panel.style.display = 'block';
      }

      function adjustMP(direction) {
        if (!selectedManageStudent) return;

        const amount = parseInt(document.getElementById('manage-mp-amount').value) || 0;
        const reason = document.getElementById('manage-mp-reason').value.trim() || 'Manual adjustment';
        const finalAmount = amount * direction;

        if (amount <= 0) {
          document.getElementById('manage-mp-result').innerHTML = '<span style="color: var(--danger);">Enter a valid amount.</span>';
          return;
        }

        document.getElementById('manage-mp-result').innerHTML = '<span style="color: var(--primary);">Processing...</span>';

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              document.getElementById('manage-mp-result').innerHTML = `<span style="color: var(--success);">‚úÖ ${result.message}. New balance: ${result.newBalance}</span>`;
              document.getElementById('manage-student-balance').textContent = result.newBalance;
              selectedManageStudent.balance = result.newBalance;
            } else {
              document.getElementById('manage-mp-result').innerHTML = `<span style="color: var(--danger);">‚ùå ${result.error}</span>`;
            }
          })
          .adjustMPFromDashboard(selectedManageStudent.token, finalAmount, reason);
      }

      function adjustInventory(direction) {
        if (!selectedManageStudent) return;

        const item = document.getElementById('manage-inv-item').value.trim();
        const qty = parseInt(document.getElementById('manage-inv-qty').value) || 1;

        if (!item) {
          document.getElementById('manage-inv-result').innerHTML = '<span style="color: var(--danger);">Enter an item name.</span>';
          return;
        }

        document.getElementById('manage-inv-result').innerHTML = '<span style="color: var(--primary);">Processing...</span>';

        const func = direction > 0 ? 'addInventoryFromDashboard' : 'removeInventoryFromDashboard';

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              document.getElementById('manage-inv-result').innerHTML = `<span style="color: var(--success);">‚úÖ Done!</span>`;
              // Refresh student details
              selectManageStudent(selectedManageStudent.token);
            } else {
              document.getElementById('manage-inv-result').innerHTML = `<span style="color: var(--danger);">‚ùå ${result.error}</span>`;
            }
          })[func](selectedManageStudent.token, item, qty);
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CURRICULUM BUILDER FUNCTIONS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      let curriculumData = null;
      let achievementDetails = {};
      let currentEditingAchievementId = null;
      let isHtmlViewMode = false;
      let expandedStudio = null;
      let expandedTrack = null;
      let expandedLevel = null;
      let expandedAssignment = null;

      // LAZY LOADING: Cache for loaded track assignments
      let trackAssignmentsCache = {};  // key: "TRACKCODE-L#", value: assignments array
      let loadingLevels = {};          // key: "TRACKCODE-L#", value: true/false

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ACHIEVEMENT DETAILS FUNCTIONS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      function loadAchievementsData() {
        document.getElementById('achievements-list').innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">Loading achievements...</p>';

        google.script.run
          .withSuccessHandler(data => {
            achievementDetails = data || {};
            renderAchievementsList();
          })
          .withFailureHandler(err => {
            document.getElementById('achievements-list').innerHTML = '<p style="color: var(--error); text-align: center; padding: 40px;">Error loading achievements: ' + err.message + '</p>';
          })
          .getAchievementDetails();
      }

      function renderAchievementsList() {
        const container = document.getElementById('achievements-list');
        const achievements = Object.values(achievementDetails);

        if (achievements.length === 0) {
          container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">No achievement details found. Click "Import JSON" to import your existing data, or "New Achievement" to create one.</p>';
          return;
        }

        // Group by track code
        const byTrack = {};
        achievements.forEach(ach => {
          const track = ach.trackCode || 'Unknown';
          if (!byTrack[track]) byTrack[track] = [];
          byTrack[track].push(ach);
        });

        let html = '';
        Object.keys(byTrack).sort().forEach(trackCode => {
          const trackAchs = byTrack[trackCode].sort((a, b) => {
            if (a.level !== b.level) return a.level - b.level;
            if (a.assignNum !== b.assignNum) return a.assignNum - b.assignNum;
            return a.achNum - b.achNum;
          });

          html += '<div class="achievement-track-group" style="margin-bottom: 20px;">';
          html += '<h4 style="color: var(--primary); margin-bottom: 10px; padding: 8px 12px; background: var(--bg-deep); border-radius: 6px; cursor: pointer;" onclick="toggleAchievementGroup(this)">';
          html += 'üìÅ ' + trackCode.toUpperCase() + ' <span style="color: var(--muted); font-weight: normal;">(' + trackAchs.length + ' achievements)</span>';
          html += '</h4>';
          html += '<div class="achievement-group-items" style="display: none; padding-left: 15px;">';

          trackAchs.forEach(ach => {
            html += '<div class="achievement-item" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer;" onclick="editAchievement(\'' + ach.id + '\')">';
            html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
            html += '<div>';
            html += '<div style="font-family: monospace; font-size: 11px; color: var(--muted); margin-bottom: 4px;">' + ach.id + '</div>';
            html += '<div style="font-weight: bold; color: #fff;">' + (ach.title || 'Untitled') + '</div>';
            if (ach.tools) html += '<div style="font-size: 11px; color: var(--secondary); margin-top: 4px;">üõ†Ô∏è ' + ach.tools + '</div>';
            html += '</div>';
            html += '<div style="text-align: right; font-size: 10px; color: var(--muted);">';
            html += 'L' + ach.level + ' / A' + ach.assignNum + ' / #' + ach.achNum;
            html += '</div>';
            html += '</div>';
            html += '</div>';
          });

          html += '</div></div>';
        });

        container.innerHTML = html;
      }

      function toggleAchievementGroup(header) {
        const items = header.nextElementSibling;
        items.style.display = items.style.display === 'none' ? 'block' : 'none';
      }

      function filterAchievements(query) {
        const q = query.toLowerCase();
        const items = document.querySelectorAll('.achievement-item');
        const groups = document.querySelectorAll('.achievement-track-group');

        if (!q) {
          // Reset - collapse all groups
          groups.forEach(g => {
            g.style.display = 'block';
            g.querySelector('.achievement-group-items').style.display = 'none';
          });
          return;
        }

        groups.forEach(group => {
          const items = group.querySelectorAll('.achievement-item');
          let hasVisible = false;

          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(q)) {
              item.style.display = 'block';
              hasVisible = true;
            } else {
              item.style.display = 'none';
            }
          });

          group.style.display = hasVisible ? 'block' : 'none';
          if (hasVisible) {
            group.querySelector('.achievement-group-items').style.display = 'block';
          }
        });
      }

      // Import Modal Functions
      function showImportAchievementsModal() {
        document.getElementById('import-json-textarea').value = '';
        document.getElementById('import-preview').style.display = 'none';
        document.getElementById('import-achievements-modal').style.display = 'flex';
      }

      function closeImportModal() {
        document.getElementById('import-achievements-modal').style.display = 'none';
      }

      function previewImport() {
        const textarea = document.getElementById('import-json-textarea');
        try {
          const data = JSON.parse(textarea.value);
          const count = Object.keys(data).length;
          document.getElementById('import-preview-count').textContent = count;
          document.getElementById('import-preview').style.display = 'block';
        } catch (e) {
          alert('Invalid JSON: ' + e.message);
        }
      }

      function executeImport() {
        const textarea = document.getElementById('import-json-textarea');
        let data;
        try {
          data = JSON.parse(textarea.value);
        } catch (e) {
          alert('Invalid JSON: ' + e.message);
          return;
        }

        document.getElementById('import-preview').innerHTML = '<span style="color: var(--primary);">Importing...</span>';

        google.script.run
          .withSuccessHandler(result => {
            alert('Import complete!\n\nImported: ' + result.imported + '\nUpdated: ' + result.updated + (result.errors.length > 0 ? '\nErrors: ' + result.errors.length : ''));
            closeImportModal();
            loadAchievementsData();
          })
          .withFailureHandler(err => {
            alert('Import failed: ' + err.message);
          })
          .importAchievementsFromJSON(data);
      }

      // Achievement Editor Functions
      function showAddAchievementModal() {
        currentEditingAchievementId = null;
        document.getElementById('ach-editor-title').textContent = 'New Achievement';
        document.getElementById('ach-editor-id').textContent = 'ID: (auto-generated from ID field)';
        document.getElementById('ach-id-input').value = '';
        document.getElementById('ach-id-input').disabled = false;
        document.getElementById('ach-title-input').value = '';
        document.getElementById('ach-description-editor').innerHTML = '';
        document.getElementById('ach-description-raw').value = '';
        document.getElementById('ach-pitfalls-input').value = '';
        document.getElementById('ach-tools-input').value = '';
        document.getElementById('ach-video-input').value = '';
        document.getElementById('ach-links-input').value = '[]';
        document.getElementById('ach-delete-btn').style.display = 'none';
        isHtmlViewMode = false;
        document.getElementById('ach-description-editor').style.display = 'block';
        document.getElementById('ach-description-raw').style.display = 'none';
        document.getElementById('achievement-editor-modal').style.display = 'flex';
      }

      function editAchievement(id) {
        const ach = achievementDetails[id];
        if (!ach) return;

        currentEditingAchievementId = id;
        document.getElementById('ach-editor-title').textContent = 'Edit Achievement';
        document.getElementById('ach-editor-id').textContent = 'ID: ' + id;
        document.getElementById('ach-id-input').value = id;
        document.getElementById('ach-id-input').disabled = true;
        document.getElementById('ach-title-input').value = ach.title || '';
        document.getElementById('ach-description-editor').innerHTML = ach.description || '';
        document.getElementById('ach-description-raw').value = ach.description || '';
        document.getElementById('ach-pitfalls-input').value = ach.pitfalls || '';
        document.getElementById('ach-tools-input').value = ach.tools || '';
        document.getElementById('ach-video-input').value = ach.videoUrl || '';
        document.getElementById('ach-links-input').value = JSON.stringify(ach.links || [], null, 2);
        document.getElementById('ach-delete-btn').style.display = 'inline-block';
        isHtmlViewMode = false;
        document.getElementById('ach-description-editor').style.display = 'block';
        document.getElementById('ach-description-raw').style.display = 'none';
        document.getElementById('achievement-editor-modal').style.display = 'flex';
      }

      function closeAchievementEditorModal() {
        document.getElementById('achievement-editor-modal').style.display = 'none';
        currentEditingAchievementId = null;
      }

      function saveAchievementFromEditor() {
        const id = document.getElementById('ach-id-input').value.trim();
        if (!id) {
          alert('Achievement ID is required!');
          return;
        }

        // Get description from the right source
        let description;
        if (isHtmlViewMode) {
          description = document.getElementById('ach-description-raw').value;
        } else {
          description = document.getElementById('ach-description-editor').innerHTML;
        }

        let links = [];
        try {
          links = JSON.parse(document.getElementById('ach-links-input').value || '[]');
        } catch (e) {
          alert('Invalid Links JSON: ' + e.message);
          return;
        }

        const detail = {
          id: id,
          title: document.getElementById('ach-title-input').value,
          description: description,
          pitfalls: document.getElementById('ach-pitfalls-input').value,
          tools: document.getElementById('ach-tools-input').value,
          videoUrl: document.getElementById('ach-video-input').value || null,
          links: links
        };

        google.script.run
          .withSuccessHandler(result => {
            alert('Achievement saved!');
            closeAchievementEditorModal();
            loadAchievementsData();
          })
          .withFailureHandler(err => {
            alert('Save failed: ' + err.message);
          })
          .saveAchievementDetail(detail);
      }

      function deleteCurrentAchievement() {
        if (!currentEditingAchievementId) return;
        if (!confirm('Delete achievement "' + currentEditingAchievementId + '"? This cannot be undone.')) return;

        google.script.run
          .withSuccessHandler(result => {
            alert('Achievement deleted.');
            closeAchievementEditorModal();
            loadAchievementsData();
          })
          .withFailureHandler(err => {
            alert('Delete failed: ' + err.message);
          })
          .deleteAchievementDetail(currentEditingAchievementId);
      }

      // WYSIWYG Editor Functions
      function wysiwygCmd(cmd) {
        document.execCommand(cmd, false, null);
        document.getElementById('ach-description-editor').focus();
      }

      function wysiwygInsertLink() {
        const url = prompt('Enter URL:');
        if (url) {
          document.execCommand('createLink', false, url);
        }
      }

      function wysiwygColor(color) {
        if (color) {
          document.execCommand('foreColor', false, color);
          document.getElementById('ach-description-editor').focus();
        }
      }

      function toggleHtmlView() {
        const editor = document.getElementById('ach-description-editor');
        const raw = document.getElementById('ach-description-raw');
        const btn = document.getElementById('html-toggle-btn');

        if (isHtmlViewMode) {
          // Switch to visual mode
          editor.innerHTML = raw.value;
          editor.style.display = 'block';
          raw.style.display = 'none';
          btn.style.background = 'var(--bg-card)';
          isHtmlViewMode = false;
        } else {
          // Switch to HTML mode
          raw.value = editor.innerHTML;
          editor.style.display = 'none';
          raw.style.display = 'block';
          btn.style.background = 'var(--primary)';
          isHtmlViewMode = true;
        }
      }

      function syncDescriptionToTextarea() {
        if (!isHtmlViewMode) {
          document.getElementById('ach-description-raw').value = document.getElementById('ach-description-editor').innerHTML;
        }
      }

      function switchCurriculumTab(tab) {
        document.getElementById('curriculum-builder-tab').style.display = 'none';
        document.getElementById('curriculum-achievements-tab').style.display = 'none';
        document.getElementById('curriculum-events-tab').style.display = 'none';
        document.getElementById('curriculum-publish-tab').style.display = 'none';
        document.getElementById('curriculum-forms-tab').style.display = 'none';
        document.getElementById('curriculum-history-tab').style.display = 'none';

        document.querySelectorAll('.curriculum-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('curriculum-' + tab + '-tab').style.display = 'block';

        // Load data for specific tabs
        if (tab === 'achievements') loadAchievementsData();
        if (tab === 'events') loadEventsData();
        if (tab === 'publish') refreshPublishQueue();
        if (tab === 'forms') loadFormsData();
        if (tab === 'history') refreshHistory();
      }

      function loadCurriculumData() {
        document.getElementById('curriculum-loading').style.display = 'block';
        document.getElementById('studios-container').innerHTML = '<p style="color: var(--muted);">Step 1: Testing connection to CurriculumSystem.gs...</p>';

        // STEP 1: Test if we can call ANY function in CurriculumSystem.gs
        google.script.run
          .withSuccessHandler(pingResult => {
            if (!pingResult) {
              document.getElementById('studios-container').innerHTML = '<div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">PING FAILED:</strong><br>pingCurriculum() returned null.<br>CurriculumSystem.gs may not be deployed.</div>';
              document.getElementById('curriculum-loading').style.display = 'none';
              return;
            }

            document.getElementById('studios-container').innerHTML = '<p style="color: #34d399;">Step 1 OK: ' + pingResult.message + '</p><p style="color: var(--muted);">Step 2: Loading curriculum data...</p>';

            // STEP 2: Now load the actual data
            google.script.run
              .withSuccessHandler(data => {
                curriculumData = data;
                document.getElementById('curriculum-loading').style.display = 'none';

                // DEBUG: Show what we received
                if (!data) {
                  document.getElementById('studios-container').innerHTML = '<div style="background: #064e3b; border: 1px solid #34d399; padding: 10px; border-radius: 8px; margin-bottom: 10px;"><strong style="color: #34d399;">‚úì Ping worked!</strong></div><div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">DATA ERROR:</strong><br>getCurriculumDashboardData() returned null.<br>The function exists but returned nothing.</div>';
                  return;
                }

                // Show debug status from backend
                let debugHtml = '';
                if (data._debug && data._debug.length > 0) {
                  debugHtml = '<div style="background: #1e3a5f; border: 1px solid #60a5fa; padding: 15px; border-radius: 8px; margin: 20px; font-family: monospace; font-size: 12px;"><strong style="color: #60a5fa;">BACKEND DEBUG:</strong><br>' + data._debug.join('<br>') + '</div>';
                }

                if (!data.curriculum) {
                  document.getElementById('studios-container').innerHTML = debugHtml + '<div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">DEBUG ERROR:</strong><br>data.curriculum is missing.<br><br>Data received: ' + JSON.stringify(Object.keys(data)) + '</div>';
                  return;
                }

                if (!data.curriculum.studios) {
                  document.getElementById('studios-container').innerHTML = debugHtml + '<div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">DEBUG ERROR:</strong><br>data.curriculum.studios is missing.<br><br>data.curriculum keys: ' + JSON.stringify(Object.keys(data.curriculum)) + '</div>';
                  return;
                }

                // Show debug info briefly
                const studioNames = Object.keys(data.curriculum.studios);
                let trackCount = 0;
                studioNames.forEach(s => {
                  if (data.curriculum.studios[s] && data.curriculum.studios[s].tracks) {
                    trackCount += data.curriculum.studios[s].tracks.length;
                  }
                });
                document.getElementById('studios-container').innerHTML = debugHtml + '<div style="background: #064e3b; border: 1px solid #34d399; padding: 10px; border-radius: 8px; margin-bottom: 20px;"><strong style="color: #34d399;">‚úì Data Loaded (Lazy Mode):</strong> ' + studioNames.length + ' studios, ' + trackCount + ' tracks</div>';

                // Now render
                try {
                  renderStudios();
                } catch (renderErr) {
                  document.getElementById('studios-container').innerHTML += '<div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">RENDER ERROR:</strong><br>' + renderErr.message + '<br><br>Stack: ' + renderErr.stack + '</div>';
                }
              })
              .withFailureHandler(err => {
                document.getElementById('curriculum-loading').style.display = 'none';
                document.getElementById('studios-container').innerHTML = '<div style="background: #064e3b; border: 1px solid #34d399; padding: 10px; border-radius: 8px; margin-bottom: 10px;"><strong style="color: #34d399;">‚úì Ping worked!</strong></div><div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">BACKEND ERROR on getCurriculumDashboardData:</strong><br>' + (err.message || err) + '</div>';
              })
              .getCurriculumDashboardData();
          })
          .withFailureHandler(err => {
            document.getElementById('curriculum-loading').style.display = 'none';
            document.getElementById('studios-container').innerHTML = '<div style="background: #450a0a; border: 1px solid #f87171; padding: 20px; border-radius: 8px; margin: 20px;"><strong style="color: #f87171;">PING ERROR:</strong><br>Could not call pingCurriculum().<br>Error: ' + (err.message || err) + '<br><br>This means CurriculumSystem.gs is not properly deployed.</div>';
          })
          .pingCurriculum();
      }

      function refreshCurriculumData() {
        // Clear lazy loading cache
        trackAssignmentsCache = {};
        loadingLevels = {};
        loadCurriculumData();
      }

      // Helper to clear cache for a specific track/level (call after saves)
      function invalidateTrackCache(trackCode, level) {
        const cacheKey = trackCode + '-L' + level;
        delete trackAssignmentsCache[cacheKey];
        delete loadingLevels[cacheKey];
      }

      function renderStudios() {
        const container = document.getElementById('studios-container');
        container.innerHTML = '';

        if (!curriculumData || !curriculumData.curriculum || !curriculumData.curriculum.studios) {
          container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">No curriculum data found. Click "+ NEW TRACK" to get started!</p>';
          return;
        }

        const studios = curriculumData.curriculum.studios;
        const studioOrder = ['Sound', 'Visual', 'Interactive'];

        studioOrder.forEach(studioName => {
          const studio = studios[studioName];
          if (!studio) return;

          const trackCount = studio.tracks ? studio.tracks.length : 0;
          // Count total levels across all tracks (lazy loading: can't count assignments until loaded)
          let levelCount = 0;
          if (studio.tracks) {
            studio.tracks.forEach(track => {
              if (track.levels) {
                levelCount += Array.isArray(track.levels) ? track.levels.length : 0;
              }
            });
          }

          const studioClass = studioName.toLowerCase();
          const icon = studioName === 'Sound' ? 'üéß' : studioName === 'Visual' ? 'üé®' : 'üéÆ';
          const isExpanded = expandedStudio === studioName;

          const card = document.createElement('div');
          card.className = 'studio-card ' + studioClass + (isExpanded ? ' expanded' : '');
          card.innerHTML = `
            <div class="studio-card-header" onclick="toggleStudio('${studioName}')">
              <div class="studio-card-title">${icon} ${studioName.toUpperCase()} STUDIO</div>
              <div class="studio-stats">
                <span>üìö ${trackCount} tracks</span>
                <span>üìä ${levelCount} levels</span>
              </div>
            </div>
            <div class="studio-card-body">
              <div class="track-list" id="tracks-${studioName}">
                ${renderTracks(studio.tracks, studioName)}
              </div>
              <button class="add-btn" onclick="showAddTrackModalForStudio('${studioName}')">+ Add Track to ${studioName}</button>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function toggleStudio(studioName) {
        if (expandedStudio === studioName) {
          expandedStudio = null;
        } else {
          expandedStudio = studioName;
          expandedTrack = null;
          expandedLevel = null;
          expandedAssignment = null;
        }
        renderStudios();
      }

      function renderTracks(tracks, studioName) {
        if (!tracks || tracks.length === 0) {
          return '<p style="color: var(--muted); padding: 20px; text-align: center;">No tracks in this studio yet.</p>';
        }

        return tracks.map(track => {
          const isExpanded = expandedTrack === track.code;
          const levelCount = track.levels ? track.levels.length : 0;

          return `
            <div class="track-item ${isExpanded ? 'expanded' : ''}">
              <div class="track-header ${isExpanded ? 'expanded' : ''}" onclick="toggleTrack('${track.code}')">
                <div class="track-info">
                  <span class="track-code">${track.code}</span>
                  <span class="track-name">${track.name}</span>
                </div>
                <div class="track-meta">
                  <span class="track-levels-count">${levelCount} levels</span>
                  <span>${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                </div>
              </div>
              <div class="track-body">
                <div class="levels-container">
                  ${renderLevels(track.levels, track.code, track.name, studioName)}
                  <button class="add-btn" onclick="showAddLevelModal('${track.code}', '${track.name}', '${studioName}')">+ Add Level</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function toggleTrack(trackCode) {
        event.stopPropagation();
        if (expandedTrack === trackCode) {
          expandedTrack = null;
        } else {
          expandedTrack = trackCode;
          expandedLevel = null;
          expandedAssignment = null;
        }
        renderStudios();
      }

      function renderLevels(levels, trackCode, trackName, studioName) {
        if (!levels || levels.length === 0) {
          return '<p style="color: var(--muted); padding: 10px;">No levels defined yet.</p>';
        }

        // LAZY LOADING: levels may be an array of numbers (e.g., [0, 1, 2])
        // or an array of objects with level.level property
        const normalizedLevels = levels.map(l => {
          if (typeof l === 'number') {
            return { level: l, assignments: null };  // Not yet loaded
          }
          return l;
        });

        return normalizedLevels.map(level => {
          const levelNum = typeof level === 'number' ? level : level.level;
          const levelKey = 'L' + levelNum;
          const cacheKey = trackCode + '-' + levelKey;
          const isExpanded = expandedLevel === (trackCode + levelKey);
          const isLoading = loadingLevels[cacheKey];

          // Check cache for loaded assignments
          let assignments = null;
          if (trackAssignmentsCache[cacheKey]) {
            assignments = trackAssignmentsCache[cacheKey];
          } else if (level.assignments) {
            assignments = level.assignments;
          }

          const assignCount = assignments ? assignments.length : '?';
          const levelNames = ['Foundation', 'Apprentice', 'Specialist', 'Expert', 'Master'];
          const levelName = levelNames[levelNum] || 'Level ' + levelNum;

          // Build body content based on loading state
          let bodyContent = '';
          if (isLoading) {
            bodyContent = '<p style="color: var(--accent-secondary); padding: 20px; text-align: center;">‚è≥ Loading assignments...</p>';
          } else if (!assignments && isExpanded) {
            // No assignments loaded yet - will trigger load in toggleLevel
            bodyContent = '<p style="color: var(--muted); padding: 20px; text-align: center;">Loading...</p>';
          } else {
            bodyContent = `
              <div class="assignments-container">
                ${renderAssignments(assignments, trackCode, trackName, studioName, levelNum)}
                <button class="add-btn" onclick="showAddAssignmentModal('${trackCode}', '${trackName}', '${studioName}', ${levelNum})">+ Add Assignment</button>
              </div>
            `;
          }

          return `
            <div class="level-card ${isExpanded ? 'expanded' : ''}">
              <div class="level-header" onclick="toggleLevel('${trackCode}', '${levelKey}', '${trackName}', '${studioName}')">
                <div>
                  <span class="level-badge">${levelKey}</span>
                  <span class="level-title">${levelName}</span>
                </div>
                <div style="color: var(--muted); font-size: 12px;">
                  ${isLoading ? '‚è≥' : assignCount + ' assignments'} ${isExpanded ? '‚ñº' : '‚ñ∂'}
                </div>
              </div>
              <div class="level-body">
                ${bodyContent}
              </div>
            </div>
          `;
        }).join('');
      }

      function toggleLevel(trackCode, levelKey, trackName, studioName) {
        event.stopPropagation();
        const key = trackCode + levelKey;
        const cacheKey = trackCode + '-' + levelKey;
        const levelNum = parseInt(levelKey.replace('L', ''));

        if (expandedLevel === key) {
          expandedLevel = null;
          renderStudios();
        } else {
          expandedLevel = key;
          expandedAssignment = null;

          // LAZY LOADING: Check if we need to fetch assignments
          if (!trackAssignmentsCache[cacheKey] && !loadingLevels[cacheKey]) {
            // Need to fetch assignments
            loadingLevels[cacheKey] = true;
            renderStudios();  // Show loading state

            google.script.run
              .withSuccessHandler(function(assignments) {
                loadingLevels[cacheKey] = false;
                trackAssignmentsCache[cacheKey] = assignments || [];
                console.log('Loaded ' + (assignments ? assignments.length : 0) + ' assignments for ' + cacheKey);
                renderStudios();  // Re-render with loaded data
              })
              .withFailureHandler(function(err) {
                loadingLevels[cacheKey] = false;
                trackAssignmentsCache[cacheKey] = [];
                console.error('Failed to load assignments for ' + cacheKey + ':', err);
                alert('Error loading assignments: ' + (err.message || err));
                renderStudios();
              })
              .getTrackAssignments(trackCode, levelNum);
          } else {
            renderStudios();
          }
        }
      }

      function renderAssignments(assignments, trackCode, trackName, studioName, level) {
        if (!assignments || assignments.length === 0) {
          return '<p style="color: var(--muted); padding: 10px;">No assignments yet.</p>';
        }

        return assignments.map(assign => {
          const assignKey = trackCode + '-L' + level + '-a' + assign.num;
          const isExpanded = expandedAssignment === assignKey;
          // Use maxMP from assignment if available, otherwise calculate from achievements
          const totalMP = assign.maxMP || (assign.achievements ? assign.achievements.reduce((sum, a) => sum + (a.mp || 0), 0) : 0);
          const achCount = assign.achievements ? assign.achievements.length : 0;
          const weekLabel = assign.week ? ` (Week ${assign.week})` : '';
          const statusIcon = assign.status === '‚úÖ Published' ? '‚úÖ' : (assign.status === '‚è≥ Ready' ? '‚è≥' : 'üìù');

          return `
            <div class="assignment-card ${isExpanded ? 'expanded' : ''}">
              <div class="assignment-header ${isExpanded ? 'expanded' : ''}" onclick="toggleAssignment('${assignKey}')">
                <span class="assignment-num">a${assign.num}${weekLabel}</span>
                <span class="assignment-title">${assign.title || 'Untitled'}</span>
                <span class="assignment-mp">${statusIcon} ${totalMP} MP</span>
              </div>
              <div class="assignment-body">
                ${assign.topic ? `<p style="color: var(--muted); margin: 0 0 10px 0; font-size: 12px;">Topic: ${assign.topic}</p>` : ''}
                ${assign.description ? `<p style="color: var(--text); margin: 0 0 10px 0; font-size: 13px;">${assign.description}</p>` : ''}
                <div class="achievements-container" id="ach-${assignKey}">
                  ${renderAchievements(assign.achievements, assignKey)}
                  <button class="add-btn" onclick="addAchievementInline('${trackCode}', '${trackName}', '${studioName}', ${level}, ${assign.num}, '${(assign.title || '').replace(/'/g, "\\'")}')">+ Add Achievement</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function toggleAssignment(assignKey) {
        event.stopPropagation();
        if (expandedAssignment === assignKey) {
          expandedAssignment = null;
        } else {
          expandedAssignment = assignKey;
        }
        renderStudios();
      }

      function renderAchievements(achievements, assignKey) {
        if (!achievements || achievements.length === 0) {
          return '<p style="color: var(--muted); padding: 10px;">No achievements defined.</p>';
        }

        return achievements.map(ach => {
          const resourceIcon = getResourceIcon(ach.resourceType);
          const resourceClass = (ach.resourceType || 'none').toLowerCase().replace(' ', '');

          return `
            <div class="achievement-item" draggable="true" data-row="${ach.rowIndex}" data-id="${ach.id}">
              <span class="achievement-drag-handle">‚ãÆ‚ãÆ</span>
              <span class="achievement-num">${ach.num}</span>
              <span class="achievement-name">${ach.name}</span>
              <input type="number" class="achievement-mp-input" value="${ach.mp}"
                     onchange="updateAchievementMP(${ach.rowIndex}, this.value)" onclick="event.stopPropagation()">
              <div class="achievement-resource">
                <span class="resource-indicator ${resourceClass}"
                      onclick="editAchievement(${ach.rowIndex}, '${ach.id}', '${ach.name.replace(/'/g, "\\'")}', ${ach.mp}, '${ach.resourceType || ''}', '${ach.resourceUrl || ''}')"
                      title="${ach.resourceUrl || 'No resource'}">${resourceIcon}</span>
              </div>
              <div class="achievement-actions">
                <button class="ach-btn" onclick="editAchievement(${ach.rowIndex}, '${ach.id}', '${ach.name.replace(/'/g, "\\'")}', ${ach.mp}, '${ach.resourceType || ''}', '${ach.resourceUrl || ''}')">‚úèÔ∏è</button>
                <button class="ach-btn delete" onclick="deleteAchievementConfirm(${ach.rowIndex}, '${ach.id}')">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');
      }

      function getResourceIcon(type) {
        switch(type) {
          case 'YouTube': return '‚ñ∂';
          case 'Link': return 'üîó';
          case 'File': return 'üìÑ';
          case 'Google Doc': return 'üìù';
          case 'Google Slides': return 'üìä';
          default: return '‚óã';
        }
      }

      // === MODAL FUNCTIONS ===

      function showAddTrackModal() {
        document.getElementById('track-modal').style.display = 'flex';
        document.getElementById('track-code-input').value = '';
        document.getElementById('track-name-input').value = '';
        document.getElementById('track-studio-input').value = 'Sound';
        document.getElementById('track-level-input').value = '0';
      }

      function showAddTrackModalForStudio(studio) {
        document.getElementById('track-modal').style.display = 'flex';
        document.getElementById('track-code-input').value = '';
        document.getElementById('track-name-input').value = '';
        document.getElementById('track-studio-input').value = studio;
        document.getElementById('track-level-input').value = '0';
      }

      function closeTrackModal() {
        document.getElementById('track-modal').style.display = 'none';
      }

      function saveNewTrack() {
        const code = document.getElementById('track-code-input').value.toUpperCase().trim();
        const name = document.getElementById('track-name-input').value.trim();
        const studio = document.getElementById('track-studio-input').value;
        const level = parseInt(document.getElementById('track-level-input').value);
        const type = document.getElementById('track-type-input').value;
        const unlockMP = parseInt(document.getElementById('track-unlock-mp-input').value) || 160;
        const prereq = document.getElementById('track-prereq-input').value.trim();

        if (!code || !name) {
          alert('Please fill in track code and name.');
          return;
        }

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              closeTrackModal();
              refreshCurriculumData();
            } else {
              alert('Error: ' + result.message);
            }
          })
          .createTrack(code, name, studio, level, unlockMP, prereq, type);
      }

      function showAddAssignmentModal(trackCode, trackName, studio, level) {
        document.getElementById('assignment-modal').style.display = 'flex';
        document.getElementById('assignment-track-code').value = trackCode;
        document.getElementById('assignment-track-name').value = trackName;
        document.getElementById('assignment-studio').value = studio;
        document.getElementById('assignment-level').value = level;
        document.getElementById('assignment-title-input').value = '';
        document.getElementById('assignment-achievements-input').value = '';

        // Calculate next assignment number
        const nextNum = getNextAssignmentNum(trackCode, level);
        document.getElementById('assignment-num-input').value = nextNum;
      }

      function getNextAssignmentNum(trackCode, level) {
        if (!curriculumData || !curriculumData.curriculum) return 1;

        const studios = curriculumData.curriculum.studios;
        for (const studio of Object.values(studios)) {
          if (!studio.tracks) continue;
          const track = studio.tracks.find(t => t.code === trackCode);
          if (!track || !track.levels) continue;

          const levelData = track.levels.find(l => l.level === level);
          if (!levelData || !levelData.assignments) return 1;

          return levelData.assignments.length + 1;
        }
        return 1;
      }

      function closeAssignmentModal() {
        document.getElementById('assignment-modal').style.display = 'none';
      }

      function saveNewAssignment() {
        const trackCode = document.getElementById('assignment-track-code').value;
        const trackName = document.getElementById('assignment-track-name').value;
        const studio = document.getElementById('assignment-studio').value;
        const level = parseInt(document.getElementById('assignment-level').value);
        const title = document.getElementById('assignment-title-input').value.trim();
        const achievementsText = document.getElementById('assignment-achievements-input').value.trim();
        const defaultMP = parseInt(document.getElementById('assignment-default-mp').value) || 10;
        const assignNum = parseInt(document.getElementById('assignment-num-input').value) || 1;

        if (!title) {
          alert('Please enter an assignment title.');
          return;
        }

        // Parse achievements (one per line)
        const achievementLines = achievementsText.split('\n').filter(line => line.trim());
        const achievements = achievementLines.map(line => ({
          name: line.trim(),
          mp: defaultMP
        }));

        if (achievements.length === 0) {
          achievements.push({ name: 'Complete the assignment', mp: defaultMP });
        }

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              closeAssignmentModal();
              refreshCurriculumData();
            } else {
              alert('Error: ' + (result.message || 'Unknown error'));
            }
          })
          .createAssignmentWithAchievements(trackCode, trackName, studio, level, assignNum, title, achievements);
      }

      function addAchievementInline(trackCode, trackName, studio, level, assignNum, assignTitle) {
        const name = prompt('Achievement name:');
        if (!name) return;

        const mp = parseInt(prompt('MP value:', '10')) || 10;
        const nextAchNum = getNextAchievementNum(trackCode, level, assignNum);

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              refreshCurriculumData();
            } else {
              alert('Error: ' + result.message);
            }
          })
          .createAchievement(trackCode, trackName, studio, level, assignNum, assignTitle, nextAchNum, name, mp, 'None', '');
      }

      function getNextAchievementNum(trackCode, level, assignNum) {
        if (!curriculumData || !curriculumData.curriculum) return 1;

        const studios = curriculumData.curriculum.studios;
        for (const studio of Object.values(studios)) {
          if (!studio.tracks) continue;
          const track = studio.tracks.find(t => t.code === trackCode);
          if (!track || !track.levels) continue;

          const levelData = track.levels.find(l => l.level === level);
          if (!levelData || !levelData.assignments) return 1;

          const assign = levelData.assignments.find(a => a.num === assignNum);
          if (!assign || !assign.achievements) return 1;

          return assign.achievements.length + 1;
        }
        return 1;
      }

      function editAchievement(rowIndex, id, name, mp, resourceType, resourceUrl) {
        event.stopPropagation();
        document.getElementById('achievement-modal').style.display = 'flex';
        document.getElementById('edit-achievement-row').value = rowIndex;
        document.getElementById('edit-achievement-id').value = id;
        document.getElementById('edit-achievement-name').value = name;
        document.getElementById('edit-achievement-mp').value = mp;
        document.getElementById('edit-achievement-resource-type').value = resourceType || 'None';
        document.getElementById('edit-achievement-url').value = resourceUrl || '';
      }

      function closeAchievementModal() {
        document.getElementById('achievement-modal').style.display = 'none';
      }

      function saveAchievementEdits() {
        const rowIndex = parseInt(document.getElementById('edit-achievement-row').value);
        const updates = {
          achievementName: document.getElementById('edit-achievement-name').value.trim(),
          mpValue: parseInt(document.getElementById('edit-achievement-mp').value),
          resourceType: document.getElementById('edit-achievement-resource-type').value,
          resourceUrl: document.getElementById('edit-achievement-url').value.trim()
        };

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              closeAchievementModal();
              refreshCurriculumData();
            } else {
              alert('Error: ' + result.message);
            }
          })
          .updateAchievement(rowIndex, updates);
      }

      function updateAchievementMP(rowIndex, newMP) {
        google.script.run
          .withSuccessHandler(result => {
            if (!result.success) {
              alert('Error updating MP: ' + result.message);
              refreshCurriculumData();
            }
          })
          .updateAchievement(rowIndex, { mpValue: parseInt(newMP) });
      }

      function deleteAchievementConfirm(rowIndex, id) {
        event.stopPropagation();
        if (confirm('Delete achievement "' + id + '"? This cannot be undone.')) {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                refreshCurriculumData();
              } else {
                alert('Error: ' + result.message);
              }
            })
            .deleteAchievement(rowIndex, true);
        }
      }

      // === EVENTS FUNCTIONS ===
      let availableLootItems = ['Mystery Box', 'Rare Item', 'Epic Item', 'Legendary Item'];

      function loadEventsData() {
        document.getElementById('events-list').innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">Loading events...</p>';

        google.script.run
          .withSuccessHandler(events => {
            console.log('Events loaded:', events);
            renderEvents(events);
          })
          .withFailureHandler(err => {
            console.error('Failed to load events:', err);
            document.getElementById('events-list').innerHTML = '<p style="color: var(--error); text-align: center; padding: 40px;">Error loading events: ' + (err.message || err) + '</p>';
          })
          .getEventsData();

        // Also load loot items for the modal
        google.script.run
          .withSuccessHandler(items => {
            console.log('Loot items loaded:', items);
            if (items && items.length > 0) {
              availableLootItems = items;
            }
          })
          .withFailureHandler(err => {
            console.error('Failed to load loot items:', err);
          })
          .getAvailableLootItems();
      }

      function formatTierReward(tier) {
        const parts = [];
        if (tier.rawMP > 0) parts.push(`+${tier.rawMP} MP`);
        if (tier.coins > 0) parts.push(`+${tier.coins} coins`);
        // Now supports BOTH MP and Coin bonuses
        if (tier.mpBonus > 0) parts.push(`+${tier.mpBonus}% MP`);
        if (tier.coinBonus > 0) parts.push(`+${tier.coinBonus}% coins`);
        if (tier.lootItem) parts.push(tier.lootItem);
        return parts.length > 0 ? parts.join(', ') : 'No rewards';
      }

      function renderEvents(events) {
        const container = document.getElementById('events-list');

        if (!events || events.length === 0) {
          container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">No events found. Create your first special event!</p>';
          return;
        }

        container.innerHTML = events.map(ev => `
          <div class="event-card ${ev.status}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <span class="event-status ${ev.status}">${ev.status.toUpperCase()}</span>
              <span style="background: linear-gradient(135deg, var(--success), #2ecc71); color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: bold;">üåç ALL STUDENTS</span>
            </div>
            <div class="event-title">${ev.name}</div>
            <div class="event-dates">üìÖ ${new Date(ev.startDate).toLocaleDateString()} - ${new Date(ev.endDate).toLocaleDateString()}</div>
            <p style="color: var(--muted); margin: 10px 0; font-size: 13px;">${ev.description || ''}</p>
            <div class="event-tiers" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px;">
              <div class="event-tier" style="background: linear-gradient(135deg, rgba(205,127,50,0.3), rgba(139,90,43,0.3)); border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 18px;">ü•â</div>
                <div style="font-size: 11px; color: #cd7f32; font-weight: bold;">Reach ${ev.tier1.mpThreshold} MP</div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 5px;">${formatTierReward(ev.tier1)}</div>
              </div>
              <div class="event-tier" style="background: linear-gradient(135deg, rgba(192,192,192,0.3), rgba(128,128,128,0.3)); border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 18px;">ü•à</div>
                <div style="font-size: 11px; color: #c0c0c0; font-weight: bold;">Reach ${ev.tier2.mpThreshold} MP</div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 5px;">${formatTierReward(ev.tier2)}</div>
              </div>
              <div class="event-tier" style="background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(184,134,11,0.3)); border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 18px;">ü•á</div>
                <div style="font-size: 11px; color: #ffd700; font-weight: bold;">Reach ${ev.tier3.mpThreshold} MP</div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 5px;">${formatTierReward(ev.tier3)}</div>
              </div>
            </div>
            ${ev.bonusDays > 0 ? `<div style="margin-top: 10px; font-size: 11px; color: var(--muted);">‚è±Ô∏è Bonus effects last ${ev.bonusDays} days</div>` : ''}
            <div style="margin-top: 15px; display: flex; gap: 10px;">
              <button class="btn-secondary" onclick="editEvent(${ev.rowIndex})" style="font-size: 12px;">‚úèÔ∏è Edit</button>
              <button class="btn-secondary" onclick="deleteEventConfirm(${ev.rowIndex}, '${ev.name}')" style="font-size: 12px; border-color: var(--danger); color: var(--danger);">üóëÔ∏è Delete</button>
            </div>
          </div>
        `).join('');
      }

      function populateLootDropdowns() {
        const selects = ['event-t1-loot', 'event-t2-loot', 'event-t3-loot'];
        selects.forEach(id => {
          const select = document.getElementById(id);
          if (!select) return;
          select.innerHTML = '<option value="">None</option>';
          availableLootItems.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            select.appendChild(opt);
          });
        });
      }

      function showAddEventModal() {
        document.getElementById('event-modal').style.display = 'flex';
        document.getElementById('event-name-input').value = '';
        document.getElementById('event-desc-input').value = '';
        document.getElementById('event-track-code-input').value = '';
        document.getElementById('event-bonus-days-input').value = '7';

        const today = new Date().toISOString().split('T')[0];
        const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('event-start-input').value = today;
        document.getElementById('event-end-input').value = nextWeek;

        // Reset tier inputs - now with separate MP and Coin bonuses
        document.getElementById('event-t1-threshold').value = '50';
        document.getElementById('event-t1-mp').value = '0';
        document.getElementById('event-t1-coins').value = '10';
        document.getElementById('event-t1-mp-bonus').value = '0';
        document.getElementById('event-t1-coin-bonus').value = '0';

        document.getElementById('event-t2-threshold').value = '100';
        document.getElementById('event-t2-mp').value = '0';
        document.getElementById('event-t2-coins').value = '25';
        document.getElementById('event-t2-mp-bonus').value = '0';
        document.getElementById('event-t2-coin-bonus').value = '0';

        document.getElementById('event-t3-threshold').value = '150';
        document.getElementById('event-t3-mp').value = '0';
        document.getElementById('event-t3-coins').value = '50';
        document.getElementById('event-t3-mp-bonus').value = '5';
        document.getElementById('event-t3-coin-bonus').value = '5';

        // Populate loot dropdowns
        populateLootDropdowns();
        document.getElementById('event-t3-loot').value = 'Mystery Box';
      }

      function closeEventModal() {
        document.getElementById('event-modal').style.display = 'none';
      }

      function saveNewEvent() {
        const eventData = {
          name: document.getElementById('event-name-input').value.trim(),
          description: document.getElementById('event-desc-input').value.trim(),
          trackCode: document.getElementById('event-track-code-input').value.trim().toLowerCase(),
          startDate: document.getElementById('event-start-input').value,
          endDate: document.getElementById('event-end-input').value,
          bonusDays: parseInt(document.getElementById('event-bonus-days-input').value) || 7,
          tier1: {
            mpThreshold: parseInt(document.getElementById('event-t1-threshold').value) || 50,
            rawMP: parseInt(document.getElementById('event-t1-mp').value) || 0,
            coins: parseInt(document.getElementById('event-t1-coins').value) || 0,
            mpBonus: parseInt(document.getElementById('event-t1-mp-bonus').value) || 0,
            coinBonus: parseInt(document.getElementById('event-t1-coin-bonus').value) || 0,
            lootItem: document.getElementById('event-t1-loot').value || ''
          },
          tier2: {
            mpThreshold: parseInt(document.getElementById('event-t2-threshold').value) || 100,
            rawMP: parseInt(document.getElementById('event-t2-mp').value) || 0,
            coins: parseInt(document.getElementById('event-t2-coins').value) || 0,
            mpBonus: parseInt(document.getElementById('event-t2-mp-bonus').value) || 0,
            coinBonus: parseInt(document.getElementById('event-t2-coin-bonus').value) || 0,
            lootItem: document.getElementById('event-t2-loot').value || ''
          },
          tier3: {
            mpThreshold: parseInt(document.getElementById('event-t3-threshold').value) || 150,
            rawMP: parseInt(document.getElementById('event-t3-mp').value) || 0,
            coins: parseInt(document.getElementById('event-t3-coins').value) || 0,
            mpBonus: parseInt(document.getElementById('event-t3-mp-bonus').value) || 0,
            coinBonus: parseInt(document.getElementById('event-t3-coin-bonus').value) || 0,
            lootItem: document.getElementById('event-t3-loot').value || ''
          }
        };

        if (!eventData.name || !eventData.startDate || !eventData.endDate) {
          alert('Please fill in event name and dates.');
          return;
        }

        google.script.run
          .withSuccessHandler(result => {
            console.log('Create event result:', result);
            if (result && result.success) {
              alert('Event created successfully!');
              closeEventModal();
              loadEventsData();
            } else {
              alert('Error: ' + (result ? result.message : 'Unknown error - result was null'));
            }
          })
          .withFailureHandler(err => {
            console.error('Create event failed:', err);
            alert('Failed to create event: ' + (err.message || err));
          })
          .createEvent(eventData);
      }

      function deleteEventConfirm(rowIndex, name) {
        if (confirm('Delete event "' + name + '"?')) {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                loadEventsData();
              } else {
                alert('Error: ' + result.message);
              }
            })
            .deleteEvent(rowIndex, true);
        }
      }

      // === PUBLISH FUNCTIONS ===

      function refreshPublishQueue() {
        google.script.run
          .withSuccessHandler(queue => {
            document.getElementById('publish-ready-count').textContent = queue.ready.length;
            document.getElementById('publish-pending-count').textContent = queue.pending.length;
            document.getElementById('publish-completed-count').textContent = queue.completed.length;
            renderPublishQueue(queue);
          })
          .getClassroomPublishQueue();
      }

      function renderPublishQueue(queue) {
        const container = document.getElementById('publish-queue-list');

        if (queue.ready.length === 0 && queue.pending.length === 0) {
          container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No items in publish queue. Add assignments in the Builder tab.</p>';
          return;
        }

        let html = '';

        if (queue.ready.length > 0) {
          html += '<h4 style="color: var(--success); margin-bottom: 10px;">Ready to Publish</h4>';
          html += queue.ready.map(item => `
            <div style="background: rgba(52, 211, 153, 0.1); border: 1px solid var(--success); border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: white;">${item.title}</strong>
                <span style="color: var(--muted); font-size: 12px; margin-left: 10px;">${item.trackCode} L${item.level} W${item.week}</span>
              </div>
              <span style="color: var(--success);">‚è≥ Ready</span>
            </div>
          `).join('');
        }

        container.innerHTML = html;
      }

      function publishAllReady() {
        const btn = document.getElementById('publish-all-btn');
        btn.disabled = true;
        btn.textContent = 'Publishing...';

        document.getElementById('publish-progress-container').style.display = 'block';

        google.script.run
          .withSuccessHandler(result => {
            btn.disabled = false;
            btn.textContent = 'üöÄ PUBLISH ALL READY';
            document.getElementById('publish-progress-container').style.display = 'none';

            if (result.success) {
              alert(`Published ${result.succeeded} of ${result.total} assignments.`);
              refreshPublishQueue();
            } else {
              alert('Error: ' + result.message);
            }
          })
          .withFailureHandler(err => {
            btn.disabled = false;
            btn.textContent = 'üöÄ PUBLISH ALL READY';
            document.getElementById('publish-progress-container').style.display = 'none';
            alert('Error: ' + err.message);
          })
          .publishToClassroomBatch([]);
      }

      // === FORMS FUNCTIONS ===

      function loadFormsData() {
        google.script.run
          .withSuccessHandler(forms => {
            renderForms(forms);
          })
          .getTrackSelectionForms();
      }

      function renderForms(forms) {
        const container = document.getElementById('forms-list');

        if (!forms || forms.length === 0) {
          container.innerHTML = `
            <div style="background: rgba(255,255,255,0.02); border: 2px dashed var(--border); border-radius: 8px; padding: 40px; text-align: center;">
              <p style="color: var(--muted);">No forms created yet.</p>
              <button class="btn-primary" style="margin-top: 15px;" onclick="createNewTrackForm()">Create Your First Form</button>
            </div>
          `;
          return;
        }

        container.innerHTML = forms.map(form => `
          <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="color: white; font-weight: bold;">${form.name || 'Track Selection Form'}</div>
                <div style="color: var(--muted); font-size: 12px;">Created: ${new Date(form.createdAt).toLocaleDateString()}</div>
              </div>
              <div style="display: flex; gap: 10px;">
                <a href="${form.formUrl}" target="_blank" class="btn-primary" style="text-decoration: none; font-size: 12px;">Open Form</a>
                <button class="btn-secondary" onclick="deleteForm('${form.id}')" style="font-size: 12px; border-color: var(--danger); color: var(--danger);">Delete</button>
              </div>
            </div>
          </div>
        `).join('');
      }

      function createNewTrackForm() {
        if (confirm('Create a new Track Selection Form? This will use your current Level 0 tracks.')) {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                alert('Form created! You can find it in the list.');
                loadFormsData();
              } else {
                alert('Error: ' + result.message);
              }
            })
            .createTrackSelectionForm('Track Selection', []);
        }
      }

      function deleteForm(formId) {
        if (confirm('Delete this form?')) {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                loadFormsData();
              }
            })
            .deleteTrackSelectionForm(formId);
        }
      }

      // === HISTORY FUNCTIONS ===

      function refreshHistory() {
        google.script.run
          .withSuccessHandler(history => {
            renderHistory(history);
          })
          .getChangeHistory(50);
      }

      function renderHistory(history) {
        const container = document.getElementById('history-list');

        if (!history || history.length === 0) {
          container.innerHTML = '<div class="history-item" style="justify-content: center; color: var(--muted);">No changes recorded yet.</div>';
          return;
        }

        container.innerHTML = history.map(item => `
          <div class="history-item ${item.undone ? 'undone' : ''}">
            <span class="history-action ${item.action.toLowerCase()}">${item.action}</span>
            <span class="history-time">${new Date(item.timestamp).toLocaleString()}</span>
            <span class="history-entity">${item.entityType}: ${item.entityId}</span>
            ${!item.undone && item.action !== 'UNDO' ? `<button class="history-undo" onclick="undoChange(${item.rowIndex})">Undo</button>` : ''}
          </div>
        `).join('');
      }

      function undoChange(rowIndex) {
        if (confirm('Undo this change?')) {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                refreshHistory();
                refreshCurriculumData();
              } else {
                alert('Error: ' + result.message);
              }
            })
            .undoChange(rowIndex);
        }
      }

      // Level modal helper
      function showAddLevelModal(trackCode, trackName, studio) {
        const level = prompt('Enter level number (0, 1, 2, 3...):', '0');
        if (level === null) return;

        const levelNum = parseInt(level);
        if (isNaN(levelNum) || levelNum < 0) {
          alert('Please enter a valid level number.');
          return;
        }

        // Create a placeholder assignment for this level
        showAddAssignmentModal(trackCode, trackName, studio, levelNum);
      }
    </script>
  </body>
</html>
